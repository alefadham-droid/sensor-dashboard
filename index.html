<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Tahoma; padding: 20px; background: #f5f7fa; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .value { font-size: 48px; font-weight: bold; }
        .temp { color: #ff6b6b; }
        .hum { color: #4d96ff; }
    </style>
</head>
<body>
<div class="container">
    <div class="card text-center mb-4">
        <h1>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
        <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32 + AHT20</p>
        <div>
            <span id="status" class="badge bg-warning">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
            <span id="updateTime" class="badge bg-info ms-2">--:--:--</span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card text-center">
                <h3><span style="color: #ff6b6b">ğŸŒ¡ï¸</span> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h3>
                <div class="value temp" id="tempValue">--</div>
                <p>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-center">
                <h3><span style="color: #4d96ff">ğŸ’§</span> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h3>
                <div class="value hum" id="humValue">--</div>
                <p>Ø¯Ø±ØµØ¯</p>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <h4>ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h4>
        <div id="dataTable">
            <p class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
    </div>

    <div class="card mt-3">
        <h4>ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ù…Ø§</h4>
        <canvas id="sensorChart" height="100"></canvas>
    </div>

    <div class="card mt-3 text-center">
        <small class="text-muted">
            Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ø± Û±Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ | 
            <span id="recordCount">Û° Ø±Ú©ÙˆØ±Ø¯</span> | 
            <button id="refreshBtn" class="btn btn-sm btn-primary">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
        </small>
    </div>
</div>

<script>
// ==================== Ø³ÛŒØ³ØªÙ… ÙÙˆÙ‚â€ŒØ³Ø§Ø¯Ù‡ ====================
const DATA_URL = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
let dataHistory = [];
let chart = null;

// ØªØ§Ø¨Ø¹ Ø§Ù…Ù† Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ù„Ù…Ø§Ù†
function getElement(id) {
    const el = document.getElementById(id);
    if (!el) {
        console.warn(`âš ï¸ Ø§Ù„Ù…Ø§Ù† ${id} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯`);
    }
    return el;
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
function updateStatus(text, type) {
    const statusEl = getElement('status');
    if (statusEl) {
        statusEl.textContent = text;
        statusEl.className = `badge bg-${type}`;
    }
}

// Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
function updateTime() {
    const timeEl = getElement('updateTime');
    if (timeEl) {
        timeEl.textContent = new Date().toLocaleTimeString('fa-IR');
    }
}

// Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
function updateStats() {
    const recordEl = getElement('recordCount');
    if (recordEl) {
        recordEl.textContent = dataHistory.length + ' Ø±Ú©ÙˆØ±Ø¯';
    }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡
async function fetchData() {
    console.log('ğŸ”„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡...');
    
    try {
        const url = DATA_URL + '?t=' + Date.now();
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
        
        processData(data);
        updateStatus('Ù…ØªØµÙ„', 'success');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§:', error);
        updateStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„', 'danger');
    }
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡
function processData(rawData) {
    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
    const dataArray = Array.isArray(rawData) ? rawData : [rawData];
    
    if (dataArray.length === 0) {
        console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
        return;
    }
    
    // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    dataArray.forEach(item => {
        const exists = dataHistory.some(d => d.id === item.id);
        if (!exists) {
            dataHistory.push(item);
        }
    });
    
    // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
    if (dataHistory.length > 50) {
        dataHistory = dataHistory.slice(-50);
    }
    
    // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
    const latest = dataArray[dataArray.length - 1];
    console.log('ğŸ“ Ø¢Ø®Ø±ÛŒÙ†:', latest);
    
    // Ø¢Ù¾Ø¯ÛŒØª UI
    updateUI(latest);
    updateTable();
    updateChart();
    updateStats();
    updateTime();
}

// Ø¢Ù¾Ø¯ÛŒØª UI
function updateUI(latest) {
    const tempEl = getElement('tempValue');
    const humEl = getElement('humValue');
    
    if (tempEl && latest.temperature !== undefined) {
        tempEl.textContent = latest.temperature.toFixed(1);
    }
    
    if (humEl && latest.humidity !== undefined) {
        humEl.textContent = latest.humidity.toFixed(1);
    }
}

// Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
function updateTable() {
    const tableEl = getElement('dataTable');
    if (!tableEl) return;
    
    const recentData = dataHistory.slice(-5).reverse();
    
    if (recentData.length === 0) {
        tableEl.innerHTML = '<p class="text-center">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
        return;
    }
    
    let html = '<table class="table table-sm"><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¯Ù…Ø§</th><th>Ø±Ø·ÙˆØ¨Øª</th></tr>';
    
    recentData.forEach(item => {
        html += `
            <tr>
                <td>${item.timestamp || '--:--:--'}</td>
                <td>${item.temperature?.toFixed(1) || '--'}Â°C</td>
                <td>${item.humidity?.toFixed(1) || '--'}%</td>
            </tr>
        `;
    });
    
    html += '</table>';
    tableEl.innerHTML = html;
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
function initChart() {
    const canvas = getElement('sensorChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Ø¯Ù…Ø§ (Â°C)',
                data: [],
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        font: {
                            family: 'Tahoma'
                        }
                    }
                }
            }
        }
    });
}

// Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
function updateChart() {
    if (!chart || dataHistory.length === 0) return;
    
    const temps = dataHistory.slice(-20).map(d => d.temperature || 0);
    const labels = dataHistory.slice(-20).map((d, i) => i + 1);
    
    chart.data.labels = labels;
    chart.data.datasets[0].data = temps;
    chart.update('none');
}

// Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…
function init() {
    console.log('ğŸš€ Ø³ÛŒØ³ØªÙ… Ø´Ø±ÙˆØ¹ Ø´Ø¯');
    
    initChart();
    
    // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
    const refreshBtn = getElement('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchData);
    }
    
    // Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ
    fetchData();
    
    // Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Û±Û° Ø«Ø§Ù†ÛŒÙ‡
    setInterval(fetchData, 10000);
    
    // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
    setInterval(updateTime, 60000);
}

// Ø´Ø±ÙˆØ¹ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
document.addEventListener('DOMContentLoaded', init);

// Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… IDÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
console.log('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡:');
['status', 'updateTime', 'tempValue', 'humValue', 'dataTable', 'recordCount', 'refreshBtn', 'sensorChart'].forEach(id => {
    const el = document.getElementById(id);
    console.log(`  ${id}:`, el ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
});
</script>
</body>
</html>
