<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Vazir', sans-serif;
            background: #f5f7fa;
            padding: 15px;
        }
        .card {
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± -->
    <div class="card bg-primary text-white">
        <div class="card-body text-center">
            <h1><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
            <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32 + AHT20</p>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row">
        <div class="col-md-6">
            <div class="card temp-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="currentTemp">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card hum-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="currentHum">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="card">
        <div class="card-body">
            <h5><i class="bi bi-table"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
            <div id="dataTable" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="card mt-4">
        <div class="card-body">
            <h5><i class="bi bi-bar-chart"></i> Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª</h5>
            <canvas id="sensorChart" height="150"></canvas>
        </div>
    </div>
</div>

<script>
    async function fetchWithCORSProxy(url) {
        try {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            const response = await fetch(proxyUrl, { headers: { 'Accept': 'application/json' } });
            if (!response.ok) throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.warn('Ø®Ø·Ø§ Ø¯Ø± proxy Ø§ÙˆÙ„:', error);
            try {
                const proxyUrl2 = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response2 = await fetch(proxyUrl2);
                if (!response2.ok) throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${response2.status}`);
                return await response2.json();
            } catch (error2) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± proxy Ø¯ÙˆÙ…:', error2);
                try {
                    const apiUrl = 'https://api.github.com/repos/alefadham-droid/sensor-dashboard/contents/data/sensor-data.json';
                    const response3 = await fetch(apiUrl);
                    if (!response3.ok) throw new Error(`Ø®Ø·Ø§ÛŒ GitHub API: ${response3.status}`);
                    const data = await response3.json();
                    const content = atob(data.content.replace(/\n/g, ''));
                    return JSON.parse(content);
                } catch (error3) {
                    console.error('ØªÙ…Ø§Ù… Ø±ÙˆØ´â€ŒÙ‡Ø§ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯:', error3);
                    throw error3;
                }
            }
        }
    }

    async function loadSensorData() {
        try {
            console.log('ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...');
            const dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
            const data = await fetchWithCORSProxy(dataUrl);
            console.log(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (${Array.isArray(data) ? data.length : 'N/A'} Ø±Ú©ÙˆØ±Ø¯)`);
            processData(data);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
            document.getElementById('dataTable').innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    <br>
                    <small>${error.message}</small>
                </div>
            `;
            showSampleData();
        }
    }

    function showSampleData() {
        const sampleData = [
            { id: 1, timestamp: "12:30:00", temperature: 25.5, humidity: 60.2 },
            { id: 2, timestamp: "12:35:00", temperature: 25.7, humidity: 59.8 }
        ];
        processData(sampleData);
        document.getElementById('dataTable').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯)
            </div>
            ${generateTableHTML(sampleData)}
        `;
    }

    let sensorChart; // Ù…ØªØºÛŒØ± Ù†Ù…ÙˆØ¯Ø§Ø±

    function renderChart(data) {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const lastData = data.slice(-10);
        const labels = lastData.map(item => item.timestamp || '');
        const temps = lastData.map(item => item.temperature ?? 0);
        const hums = lastData.map(item => item.humidity ?? 0);

        if (sensorChart) {
            sensorChart.data.labels = labels;
            sensorChart.data.datasets[0].data = temps;
            sensorChart.data.datasets[1].data = hums;
            sensorChart.update();
        } else {
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø¯Ù…Ø§ (Â°C)',
                            data: temps,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            data: hums,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Ø¯Ù…Ø§ (Â°C)'
                            },
                            min: 0
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Ø±Ø·ÙˆØ¨Øª (%)'
                            },
                            min: 0
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { font: { family: 'Vazir, sans-serif' } }
                        }
                    }
                }
            });
        }
    }

    function processData(data) {
        if (!Array.isArray(data) || data.length === 0) {
            console.warn('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø®Ø§Ù„ÛŒ Ù‡Ø³ØªÙ†Ø¯');
            document.getElementById('currentTemp').textContent = '--';
            document.getElementById('currentHum').textContent = '--';
            return;
        }

        const latest = data[data.length - 1];

        if (latest.temperature !== undefined) {
            document.getElementById('currentTemp').textContent = latest.temperature.toFixed(1);
        }

        if (latest.humidity !== undefined) {
            document.getElementById('currentHum').textContent = latest.humidity.toFixed(1);
        }

        updateTable(data.slice(-10));

        renderChart(data.slice(-10));
    }

    function updateTable(data) {
        let tableHTML = `
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø²Ù…Ø§Ù†</th>
                        <th>Ø¯Ù…Ø§ (Â°C)</th>
                        <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.reverse().forEach(item => {
            tableHTML += `
                <tr>
                    <td>${item.id || '--'}</td>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature !== undefined ? item.temperature.toFixed(1) : '--'}</td>
                    <td>${item.humidity !== undefined ? item.humidity.toFixed(1) : '--'}</td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';

        document.getElementById('dataTable').innerHTML = tableHTML;
    }

    function generateTableHTML(data) {
        let html = `
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø²Ù…Ø§Ù†</th>
                        <th>Ø¯Ù…Ø§ (Â°C)</th>
                        <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                    </tr>
                </thead>
                <tbody>
        `;
        data.reverse().forEach(item => {
            html += `
                <tr>
                    <td>${item.id || '--'}</td>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature !== undefined ? item.temperature.toFixed(1) : '--'}</td>
                    <td>${item.humidity !== undefined ? item.humidity.toFixed(1) : '--'}</td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        return html;
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…...');
        loadSensorData();
    });
</script>

<!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
</body>
</html>
