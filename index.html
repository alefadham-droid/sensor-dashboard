<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Vazir', sans-serif;
            background: #f5f7fa;
            padding: 15px;
        }
        .card {
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
        }
        .status-bar {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            font-size: 12px;
            text-align: center;
            z-index: 1000;
        }
        .last-update {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± -->
    <div class="card bg-primary text-white">
        <div class="card-body text-center">
            <h1><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
            <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32 + AHT20</p>
            <div id="lastUpdate" class="last-update">
                <i class="bi bi-clock"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: --
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row">
        <div class="col-md-6">
            <div class="card temp-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="currentTemp">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card hum-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="currentHum">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="card">
        <div class="card-body">
            <h5><i class="bi bi-table"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Û±Û° Ø±Ú©ÙˆØ±Ø¯ Ø¢Ø®Ø±)</h5>
            <div id="dataTable" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="card mt-4">
        <div class="card-body">
            <h5><i class="bi bi-bar-chart"></i> Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª (Û±Û° Ø±Ú©ÙˆØ±Ø¯ Ø¢Ø®Ø±)</h5>
            <canvas id="sensorChart" height="150"></canvas>
        </div>
    </div>
</div>

<div id="statusBar" class="status-bar d-none">
    <span id="statusText">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
</div>

<script>
    let lastUpdateTime = null;
    let retryCount = 0;
    const maxRetries = 3;

    async function fetchWithCORSProxy(url) {
        try {
            const proxyUrl2 = 'https://corsproxy.io/?' + encodeURIComponent(url);
            const response2 = await fetch(proxyUrl2);
            if (!response2.ok) throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${response2.status}`);
            retryCount = 0; // Reset retry count on success
            return await response2.json();
        } catch (error2) {
            console.warn('Ø®Ø·Ø§ Ø¯Ø± proxy Ø§ÙˆÙ„:', error2);
            retryCount++;
            
            if (retryCount <= maxRetries) {
                console.log(`ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ${retryCount}/${maxRetries}`);
                // Wait 2 seconds before retry
                await new Promise(resolve => setTimeout(resolve, 2000));
                return fetchWithCORSProxy(url);
            }
            
            try {
                console.log('ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² GitHub API...');
                const apiUrl = 'https://api.github.com/repos/alefadham-droid/sensor-dashboard/contents/data/sensor-data.json';
                const response3 = await fetch(apiUrl);
                if (!response3.ok) throw new Error(`Ø®Ø·Ø§ÛŒ GitHub API: ${response3.status}`);
                const data = await response3.json();
                const content = atob(data.content.replace(/\n/g, ''));
                return JSON.parse(content);
            } catch (error3) {
                console.error('ØªÙ…Ø§Ù… Ø±ÙˆØ´â€ŒÙ‡Ø§ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯:', error3);
                throw error3;
            }
        }
    }

    function showStatus(message, type = 'info') {
        const statusBar = document.getElementById('statusBar');
        const statusText = document.getElementById('statusText');
        
        statusText.textContent = message;
        statusBar.className = `status-bar bg-${type} text-white`;
        statusBar.classList.remove('d-none');
        
        // Hide after 5 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                statusBar.classList.add('d-none');
            }, 5000);
        }
    }

    function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('fa-IR');
        lastUpdateTime = now;
        
        document.getElementById('lastUpdate').innerHTML = `
            <i class="bi bi-clock"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${timeString}
        `;
    }

    async function loadSensorData() {
        try {
            showStatus('ğŸ“¥ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...', 'info');
            const dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
            const data = await fetchWithCORSProxy(dataUrl);
            
            if (!Array.isArray(data)) {
                throw new Error('ÙØ±Ù…Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            }
            
            console.log(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (${data.length} Ø±Ú©ÙˆØ±Ø¯)`);
            showStatus(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (${data.length} Ø±Ú©ÙˆØ±Ø¯)`, 'success');
            updateLastUpdateTime();
            processData(data);
            
            // Auto-refresh every 30 seconds
            setTimeout(loadSensorData, 30000);
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
            showStatus(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ${error.message}`, 'danger');
            document.getElementById('dataTable').innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    <br>
                    <small>${error.message}</small>
                </div>
            `;
            showSampleData();
            
            // Retry after 10 seconds on error
            setTimeout(loadSensorData, 10000);
        }
    }

    function showSampleData() {
        const sampleData = [
            { id: 1, timestamp: "12:30:00", temperature: 25.5, humidity: 60.2 },
            { id: 2, timestamp: "12:35:00", temperature: 25.7, humidity: 59.8 },
            { id: 3, timestamp: "12:40:00", temperature: 25.8, humidity: 59.5 },
            { id: 4, timestamp: "12:45:00", temperature: 25.6, humidity: 60.0 }
        ];
        processData(sampleData);
        document.getElementById('dataTable').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯)
            </div>
            ${generateTableHTML(sampleData)}
        `;
    }

    let sensorChart = null;

    function renderChart(data) {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const lastData = data.slice(-10);
        const labels = lastData.map(item => item.timestamp || '');
        const temps = lastData.map(item => item.temperature ?? 0);
        const hums = lastData.map(item => item.humidity ?? 0);

        if (sensorChart) {
            sensorChart.data.labels = labels;
            sensorChart.data.datasets[0].data = temps;
            sensorChart.data.datasets[1].data = hums;
            sensorChart.update('none'); // Smooth update
        } else {
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø¯Ù…Ø§ (Â°C)',
                            data: temps,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            data: hums,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    family: 'Vazir, sans-serif'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Ø¯Ù…Ø§ (Â°C)',
                                font: {
                                    family: 'Vazir, sans-serif'
                                }
                            },
                            min: Math.min(...temps) - 2,
                            max: Math.max(...temps) + 2
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Ø±Ø·ÙˆØ¨Øª (%)',
                                font: {
                                    family: 'Vazir, sans-serif'
                                }
                            },
                            min: Math.min(...hums) - 5,
                            max: Math.max(...hums) + 5
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { 
                                font: { 
                                    family: 'Vazir, sans-serif',
                                    size: 14
                                } 
                            }
                        },
                        tooltip: {
                            rtl: true,
                            titleFont: {
                                family: 'Vazir, sans-serif'
                            },
                            bodyFont: {
                                family: 'Vazir, sans-serif'
                            }
                        }
                    }
                }
            });
        }
    }

    function processData(data) {
        if (!Array.isArray(data) || data.length === 0) {
            console.warn('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø®Ø§Ù„ÛŒ Ù‡Ø³ØªÙ†Ø¯');
            document.getElementById('currentTemp').textContent = '--';
            document.getElementById('currentHum').textContent = '--';
            return;
        }

        const latest = data[data.length - 1];

        if (latest.temperature !== undefined) {
            document.getElementById('currentTemp').textContent = latest.temperature.toFixed(1);
        }

        if (latest.humidity !== undefined) {
            document.getElementById('currentHum').textContent = latest.humidity.toFixed(1);
        }

        updateTable(data.slice(-10));
        renderChart(data);
    }

    function updateTable(data) {
        let tableHTML = `
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§ (Â°C)</th>
                            <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.reverse().forEach(item => {
            const tempClass = item.temperature > 28 ? 'table-warning' : '';
            const humClass = item.humidity > 70 ? 'table-info' : '';
            
            tableHTML += `
                <tr>
                    <td>${item.id || '--'}</td>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td class="${tempClass}">${item.temperature !== undefined ? item.temperature.toFixed(1) : '--'}</td>
                    <td class="${humClass}">${item.humidity !== undefined ? item.humidity.toFixed(1) : '--'}</td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table></div>';

        document.getElementById('dataTable').innerHTML = tableHTML;
    }

    function generateTableHTML(data) {
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§ (Â°C)</th>
                            <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        data.reverse().forEach(item => {
            html += `
                <tr>
                    <td>${item.id || '--'}</td>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature !== undefined ? item.temperature.toFixed(1) : '--'}</td>
                    <td>${item.humidity !== undefined ? item.humidity.toFixed(1) : '--'}</td>
                </tr>
            `;
        });
        html += '</tbody></table></div>';
        return html;
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯...');
        showStatus('Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
        loadSensorData();
    });

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÛŒ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'r' || e.key === 'R') {
            loadSensorData();
            showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÛŒ...', 'info');
        }
    });
</script>

<!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
</body>
</html>
