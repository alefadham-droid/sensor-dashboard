<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Tahoma, sans-serif; 
            background: #f8f9fa; 
            padding: 15px;
        }
        .card { 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .temp-card { 
            background: linear-gradient(135deg, #ff6b6b, #ffa8a8); 
            color: white; 
        }
        .hum-card { 
            background: linear-gradient(135deg, #4d96ff, #6bc5ff); 
            color: white; 
        }
        .sensor-value { 
            font-size: 3rem; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± Ø³Ø§Ø¯Ù‡ -->
    <div class="card bg-primary text-white mb-3">
        <div class="card-body text-center">
            <h4><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h4>
            <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32</p>
            <div>
                <span id="status" class="badge bg-warning">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
                <span id="updateTime" class="badge bg-info ms-2">--:--:--</span>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card temp-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="tempValue">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card hum-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="humValue">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="bi bi-table"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
            <div id="dataTable">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÛŒÙ† -->
    <div class="card">
        <div class="card-body text-center">
            <small class="text-muted">
                <span id="recordInfo">0 Ø±Ú©ÙˆØ±Ø¯</span> | 
                <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank">
                    <i class="bi bi-github"></i> Ù…Ø®Ø²Ù† GitHub
                </a>
            </small>
        </div>
    </div>
</div>

<script>
// ============================================
// Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ùˆ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§
// ============================================

const DATA_URL = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
let dataHistory = [];
let totalRecords = 0;
let isConnected = true;
let updateInterval = null;

// Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…
console.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...');

// ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡
async function fetchSensorData() {
    console.log('ğŸ”„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡...');
    
    try {
        const timestamp = Date.now();
        const url = `${DATA_URL}?t=${timestamp}`;
        
        const response = await fetch(url);
        console.log('ğŸ“¡ ÙˆØ¶Ø¹ÛŒØª HTTP:', response.status);
        
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
        
        processData(data);
        updateStatus('Ù…ØªØµÙ„', 'success');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª:', error.message);
        updateStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„', 'danger');
    }
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡
function processData(rawData) {
    try {
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
        console.log(`ğŸ“Š ${dataArray.length} Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`);
        
        if (dataArray.length === 0) {
            console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
            return;
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø¨Ø¯ÙˆÙ† ØªÚ©Ø±Ø§Ø±)
        dataArray.forEach(newItem => {
            const exists = dataHistory.some(item => item.id === newItem.id);
            if (!exists) {
                dataHistory.push(newItem);
                totalRecords++;
            }
        });
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (dataHistory.length > 50) {
            dataHistory = dataHistory.slice(-50);
        }
        
        // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
        const latest = dataArray[dataArray.length - 1];
        console.log('ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯:', latest);
        
        // Ø¢Ù¾Ø¯ÛŒØª UI
        updateUI(latest);
        updateTable();
        updateStats();
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡:', error);
    }
}

// Ø¢Ù¾Ø¯ÛŒØª UI
function updateUI(latest) {
    try {
        // Ø¯Ù…Ø§
        const tempElement = document.getElementById('tempValue');
        if (tempElement && latest.temperature !== undefined) {
            tempElement.textContent = latest.temperature.toFixed(1);
        }
        
        // Ø±Ø·ÙˆØ¨Øª
        const humElement = document.getElementById('humValue');
        if (humElement && latest.humidity !== undefined) {
            humElement.textContent = latest.humidity.toFixed(1);
        }
        
        // Ø²Ù…Ø§Ù†
        const timeElement = document.getElementById('updateTime');
        if (timeElement) {
            timeElement.textContent = new Date().toLocaleTimeString('fa-IR');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª UI:', error);
    }
}

// Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
function updateTable() {
    try {
        const tableContainer = document.getElementById('dataTable');
        if (!tableContainer) return;
        
        const recentData = dataHistory.slice(-5).reverse();
        
        if (recentData.length === 0) {
            tableContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡
                </div>
            `;
            return;
        }
        
        let html = '<table class="table table-sm"><thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¯Ù…Ø§</th><th>Ø±Ø·ÙˆØ¨Øª</th></tr></thead><tbody>';
        
        recentData.forEach(item => {
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature !== undefined ? item.temperature.toFixed(1) + 'Â°C' : '--'}</td>
                    <td>${item.humidity !== undefined ? item.humidity.toFixed(1) + '%' : '--'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        tableContainer.innerHTML = html;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„:', error);
    }
}

// Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
function updateStats() {
    try {
        const recordElement = document.getElementById('recordInfo');
        if (recordElement) {
            recordElement.textContent = dataHistory.length + ' Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡';
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±:', error);
    }
}

// Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
function updateStatus(text, type) {
    try {
        const element = document.getElementById('status');
        if (element) {
            element.textContent = text;
            element.className = `badge bg-${type}`;
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª:', error);
    }
}

// Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±
function startAutoUpdate() {
    isConnected = true;
    updateInterval = setInterval(fetchSensorData, 5000);
    console.log('ğŸ”„ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯ (Ù‡Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡)');
}

// ØªÙˆÙ‚Ù Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±
function stopAutoUpdate() {
    isConnected = false;
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
    console.log('â¹ï¸ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯');
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
function initDashboard() {
    console.log('ğŸ¯ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...');
    console.log('ğŸ“ Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡:', DATA_URL);
    
    // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    fetchSensorData();
    
    // Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±
    startAutoUpdate();
    
    // Ú©Ù„ÛŒØ¯ R Ø¨Ø±Ø§ÛŒ refresh Ø¯Ø³ØªÛŒ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'r' || e.key === 'R') {
            fetchSensorData();
            console.log('ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ...');
        }
    });
    
    console.log('âœ… Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
}

// Ø´Ø±ÙˆØ¹ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>
