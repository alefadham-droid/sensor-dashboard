<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Vazir', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .temp-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: white;
        }
        
        .hum-card {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: white;
        }
        
        .data-card {
            background: white;
            color: var(--dark);
        }
        
        .sensor-value {
            font-size: 3rem;
            font-weight: bold;
        }
        
        .unit {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .last-update {
            font-size: 0.9rem;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .online {
            background: #28a745;
            color: white;
        }
        
        .offline {
            background: #dc3545;
            color: white;
        }
        
        table {
            font-size: 0.9rem;
        }
        
        table th {
            background: var(--primary);
            color: white;
        }
        
        .refresh-btn {
            background: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .sensor-value {
                font-size: 2rem;
            }
            
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ù‡Ø¯Ø± -->
        <div class="card header-card">
            <div class="card-body text-center">
                <h1><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ ESP32</h1>
                <p class="mb-0">
                    <i class="bi bi-cpu"></i> Ø³Ù†Ø³ÙˆØ± AHT20 | 
                    <i class="bi bi-wifi"></i> WiFi | 
                    <i class="bi bi-github"></i> GitHub Storage
                </p>
                <div class="mt-3">
                    <button id="refreshBtn" class="refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                    <span id="lastUpdate" class="last-update ms-3">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
        <div class="row">
            <div class="col-md-6">
                <div class="card temp-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentTemp">--</div>
                        <div class="unit">Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxTemp">--</span>Â°C</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minTemp">--</span>Â°C</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card hum-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentHum">--</div>
                        <div class="unit">Ø¯Ø±ØµØ¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxHum">--</span>%</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minHum">--</span>%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div class="card data-card">
            <div class="card-body">
                <h5><i class="bi bi-graph-up"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
                <canvas id="sensorChart" height="100"></canvas>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
        <div class="card data-card">
            <div class="card-body">
                <h5><i class="bi bi-table"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø²Ù…Ø§Ù†</th>
                                <th>Ø¯Ù…Ø§ (Â°C)</th>
                                <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                                <th>Ø³Ù†Ø³ÙˆØ±</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´Ù† -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… -->
        <div class="card data-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h6><i class="bi bi-wifi"></i> ÙˆØ¶Ø¹ÛŒØª ESP32</h6>
                        <span id="deviceStatus" class="status-badge online">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6><i class="bi bi-database"></i> ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h6>
                        <span id="dataCount" class="sensor-value">0</span>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6><i class="bi bi-clock"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</h6>
                        <span id="lastDataTime">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÙÙˆØªØ± -->
        <div class="text-center mt-4">
            <div class="card data-card">
                <div class="card-body">
                    <p class="mb-0">
                        <i class="bi bi-github"></i> 
                        Ø³ÙˆØ±Ø³ Ú©Ø¯: 
                        <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank">
                            github.com/alefadham-droid/sensor-dashboard
                        </a>
                        | 
                        <i class="bi bi-cpu"></i>
                        ESP32 + AHT20
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sensorChart;
        let sensorData = [];

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        async function loadSensorData() {
            try {
                console.log("ğŸ“¥ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...");
                
                // Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
                const dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² cache
                const timestamp = new Date().getTime();
                const response = await fetch(dataUrl + '?t=' + timestamp);
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:", data);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                processData(data);
                
                // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
                const now = new Date();
                const timeStr = now.toLocaleTimeString('fa-IR');
                document.getElementById('lastUpdate').innerHTML = 
                    `<i class="bi bi-clock"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${timeStr}`;
                    
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                document.getElementById('deviceStatus').className = 'status-badge offline';
                document.getElementById('deviceStatus').textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†';
                
                // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                            <br>
                            <small>${error.message}</small>
                        </td>
                    </tr>
                `;
            }
        }

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function processData(data) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            sensorData = Array.isArray(data) ? data : [];
            
            console.log(`ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${sensorData.length}`);
            
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…
            if (sensorData.length === 0) {
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
            sensorData.sort((a, b) => {
                if (a.id && b.id) return b.id - a.id;
                if (a.unix_time && b.unix_time) return b.unix_time - a.unix_time;
                return 0;
            });
            
            // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
            updateCards();
            
            // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
            updateChart();
            
            // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
            updateTable();
            
            // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
            updateStatus();
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
        function updateCards() {
            const latest = sensorData[0];
            
            // Ù…Ù‚Ø§Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
            document.getElementById('currentTemp').textContent = 
                latest.temperature ? latest.temperature.toFixed(1) : '--';
            document.getElementById('currentHum').textContent = 
                latest.humidity ? latest.humidity.toFixed(1) : '--';
            document.getElementById('lastDataTime').textContent = 
                latest.timestamp || '--';
            document.getElementById('dataCount').textContent = sensorData.length;
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ min/max
            const temps = sensorData.map(d => d.temperature).filter(t => t != null);
            const hums = sensorData.map(d => d.humidity).filter(h => h != null);
            
            if (temps.length > 0) {
                document.getElementById('maxTemp').textContent = Math.max(...temps).toFixed(1);
                document.getElementById('minTemp').textContent = Math.min(...temps).toFixed(1);
            }
            
            if (hums.length > 0) {
                document.getElementById('maxHum').textContent = Math.max(...hums).toFixed(1);
                document.getElementById('minHum').textContent = Math.min(...hums).toFixed(1);
            }
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        function updateChart() {
            // ÙÙ‚Ø· 20 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø± Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
            const recentData = sensorData.slice(0, 20).reverse();
            
            const labels = recentData.map(d => d.timestamp || `#${d.id}`);
            const temps = recentData.map(d => d.temperature);
            const hums = recentData.map(d => d.humidity);
            
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            if (sensorChart) {
                sensorChart.destroy();
            }
            
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø¯Ù…Ø§ (Â°C)',
                            data: temps,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            data: hums,
                            borderColor: '#4d96ff',
                            backgroundColor: 'rgba(77, 150, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            // ÙÙ‚Ø· 10 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø± Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
            const displayData = sensorData.slice(0, 10);
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                
                // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù…Ø§
                let tempColor = 'success';
                if (item.temperature > 30) tempColor = 'danger';
                else if (item.temperature > 25) tempColor = 'warning';
                
                // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ø·ÙˆØ¨Øª
                let humColor = 'success';
                if (item.humidity > 80) humColor = 'danger';
                else if (item.humidity > 60) humColor = 'warning';
                
                row.innerHTML = `
                    <td>${item.id || '--'}</td>
                    <td>${item.timestamp || '--'}</td>
                    <td>
                        <span class="badge bg-${tempColor}">
                            ${item.temperature ? item.temperature.toFixed(1) : '--'}Â°C
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${humColor}">
                            ${item.humidity ? item.humidity.toFixed(1) : '--'}%
                        </span>
                    </td>
                    <td>${item.sensor || 'AHT20'}</td>
                    <td>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Ø«Ø¨Øª Ø´Ø¯Ù‡
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
        function updateStatus() {
            const latest = sensorData[0];
            if (!latest) return;
            
            const latestTime = latest.unix_time || 0;
            const currentTime = Math.floor(Date.now() / 1000);
            const isOnline = (currentTime - latestTime) < 300; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡
            
            const statusEl = document.getElementById('deviceStatus');
            statusEl.className = isOnline ? 'status-badge online' : 'status-badge offline';
            statusEl.textContent = isOnline ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
        document.getElementById('refreshBtn').addEventListener('click', loadSensorData);
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        loadSensorData();
        
        // Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
        setInterval(loadSensorData, 30000);
    </script>

    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</body>
</html>
