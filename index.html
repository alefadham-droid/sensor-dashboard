<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Tahoma', 'Vazir', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
            border: none;
        }
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
            border: none;
        }
        .sensor-value { 
            font-size: 3.5rem; 
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .live-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .data-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .table thead th {
            position: sticky;
            top: 0;
            background: #343a40;
            color: white;
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± -->
    <div class="glass-card bg-primary text-white position-relative">
        <span class="live-badge">LIVE</span>
        <div class="card-body text-center">
            <h1 class="display-6">
                <i class="bi bi-lightning-charge-fill"></i> 
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Real-Time Ø³Ù†Ø³ÙˆØ± ESP32
            </h1>
            <p class="mb-2">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù†Ø¯Ù‡ Ø§Ø² ESP32 + AHT20</p>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <span id="status" class="badge bg-warning">
                        <i class="bi bi-circle-fill"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
                    </span>
                </div>
                <div class="col-auto">
                    <span id="lastUpdate" class="badge bg-info">
                        <i class="bi bi-clock"></i> 
                        <span id="updateTime">--:--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="glass-card temp-card">
                <div class="card-body text-center py-4">
                    <h4><i class="bi bi-thermometer-sun"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h4>
                    <div class="sensor-value" id="tempValue">--</div>
                    <div class="mt-2">Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                    <div class="mt-3">
                        <small><i class="bi bi-arrow-repeat"></i> 
                        <span id="tempUpdateRate">0</span> Ø«Ø§Ù†ÛŒÙ‡ Ù¾ÛŒØ´</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="glass-card hum-card">
                <div class="card-body text-center py-4">
                    <h4><i class="bi bi-droplet-half"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h4>
                    <div class="sensor-value" id="humValue">--</div>
                    <div class="mt-2">Ø¯Ø±ØµØ¯</div>
                    <div class="mt-3">
                        <small><i class="bi bi-arrow-repeat"></i> 
                        <span id="humUpdateRate">0</span> Ø«Ø§Ù†ÛŒÙ‡ Ù¾ÛŒØ´</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
    <div class="glass-card">
        <div class="card-body">
            <h5><i class="bi bi-sliders"></i> Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Real-Time</h5>
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label">Ø³Ø±Ø¹Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</label>
                    <select id="refreshRate" class="form-select">
                        <option value="5000" selected>Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡</option>
                        <option value="10000">Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡</option>
                        <option value="30000">Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡</option>
                    </select>
                </div>
                <div class="col-md-6 text-center mt-3 mt-md-0">
                    <div class="d-flex justify-content-center gap-2">
                        <button id="connectBtn" class="btn btn-success">
                            <i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„
                        </button>
                        <button id="resetBtn" class="btn btn-warning">
                            <i class="bi bi-arrow-clockwise"></i> Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
                        </button>
                    </div>
                    <div class="mt-2">
                        <span id="dataCount" class="badge bg-info">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: 0</span>
                        <span id="updateRate" class="badge bg-success ms-2">0/s</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="card-body">
                    <h5><i class="bi bi-graph-up-arrow"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
                    <div class="chart-container">
                        <canvas id="sensorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="glass-card h-100">
                <div class="card-body">
                    <h5><i class="bi bi-list-columns-reverse"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
                    <div class="data-table" id="dataTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                            </div>
                            <p class="mt-2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="glass-card mt-3">
        <div class="card-body">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                <span id="recordCount">0 Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ</span> | 
                Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª ESP32: <span id="espLastUpdate">--:--:--</span> |
                <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> Ù…Ø®Ø²Ù† GitHub
                </a>
            </small>
        </div>
    </div>
</div>

<script>
class SensorDashboard {
    constructor() {
        this.dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
        this.data = [];
        this.chart = null;
        this.updateInterval = null;
        this.retryCount = 0;
        this.totalRecords = 0;
        this.lastDataTime = null;
        
        this.init();
    }

    init() {
        console.log('ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...');
        this.initChart();
        this.setupEventListeners();
        this.updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...', 'warning');
        this.startAutoUpdate();
        this.startUptimeCounter();
    }

    setupEventListeners() {
        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        document.getElementById('connectBtn').addEventListener('click', () => this.toggleConnection());
        document.getElementById('resetBtn').addEventListener('click', () => this.resetData());
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        document.getElementById('refreshRate').addEventListener('change', (e) => {
            this.configRefreshRate = parseInt(e.target.value);
            this.restartAutoUpdate();
        });

        // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                this.fetchData();
                this.updateStatus('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ...', 'info');
            }
            if (e.key === ' ') {
                e.preventDefault();
                this.toggleConnection();
            }
        });
    }

    async fetchData() {
        try {
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ø¨Ø§ timestamp
            const timestamp = Date.now();
            const url = `${this.dataUrl}?t=${timestamp}`;
            
            console.log(`ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø²: ${url}`);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const jsonData = await response.json();
            console.log('âœ… Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', jsonData);
            
            // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡ Ùˆ ØªÚ© Ø±Ú©ÙˆØ±Ø¯)
            const dataArray = this.normalizeData(jsonData);
            console.log(`ğŸ“Š Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø±Ù…Ø§Ù„â€ŒØ´Ø¯Ù‡: ${dataArray.length} Ø±Ú©ÙˆØ±Ø¯`);
            
            this.processData(dataArray);
            this.retryCount = 0;
            this.updateStatus('Ù…ØªØµÙ„', 'success');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
            this.retryCount++;
            
            if (this.retryCount > 3) {
                this.updateStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„', 'danger');
                this.showSampleData();
            } else {
                this.updateStatus(`ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ (${this.retryCount}/3)`, 'warning');
            }
        }
    }

    // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¢Ø±Ø§ÛŒÙ‡ ÛŒØ§ ØªÚ© Ø±Ú©ÙˆØ±Ø¯)
    normalizeData(data) {
        if (Array.isArray(data)) {
            return data;
        } else if (data && typeof data === 'object') {
            return [data];
        } else {
            console.warn('âš ï¸ ÙØ±Ù…Øª Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±:', data);
            return [];
        }
    }

    processData(dataArray) {
        if (!dataArray || dataArray.length === 0) {
            console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            return;
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        dataArray.forEach(item => {
            this.data.push(item);
            this.totalRecords++;
        });
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ 100 Ø±Ú©ÙˆØ±Ø¯
        if (this.data.length > 100) {
            this.data = this.data.slice(-100);
        }
        
        // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
        const latest = dataArray[dataArray.length - 1];
        console.log('ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯:', latest);
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
        this.updateCurrentValues(latest);
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
        this.updateTable(dataArray.slice(-8).reverse());
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        this.updateChart();
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
        this.updateStats();
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª
        this.lastDataTime = new Date();
    }

    updateCurrentValues(latest) {
        // Ø¯Ù…Ø§
        if (latest.temperature !== undefined && latest.temperature !== null) {
            document.getElementById('tempValue').textContent = latest.temperature.toFixed(1);
        }
        
        // Ø±Ø·ÙˆØ¨Øª
        if (latest.humidity !== undefined && latest.humidity !== null) {
            document.getElementById('humValue').textContent = latest.humidity.toFixed(1);
        }
        
        // Ø²Ù…Ø§Ù†
        const now = new Date();
        const timeStr = now.toLocaleTimeString('fa-IR');
        document.getElementById('updateTime').textContent = timeStr;
        
        // Ø²Ù…Ø§Ù† Ø¢Ù¾Ø¯ÛŒØª ESP32
        if (latest.timestamp) {
            document.getElementById('espLastUpdate').textContent = latest.timestamp;
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡
        if (this.lastDataTime) {
            const secondsAgo = Math.floor((now - this.lastDataTime) / 1000);
            document.getElementById('tempUpdateRate').textContent = secondsAgo;
            document.getElementById('humUpdateRate').textContent = secondsAgo;
        }
    }

    updateTable(dataArray) {
        const tableContainer = document.getElementById('dataTable');
        
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§</th>
                            <th>Ø±Ø·ÙˆØ¨Øª</th>
                            <th>Ø´Ù†Ø§Ø³Ù‡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        dataArray.forEach((item, index) => {
            // ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø¯Ø§Ø±
            const tempClass = item.temperature > 28 ? 'table-warning' : '';
            const humClass = item.humidity > 70 ? 'table-info' : '';
            
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td class="${tempClass}">${item.temperature?.toFixed(1) || '--'}Â°C</td>
                    <td class="${humClass}">${item.humidity?.toFixed(1) || '--'}%</td>
                    <td><span class="badge bg-secondary">${item.id || '--'}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
    }

    initChart() {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ø¯Ù…Ø§ (Â°C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                        data: [],
                        borderColor: '#4d96ff',
                        backgroundColor: 'rgba(77, 150, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        grid: {
                            display: true,
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 11
                            },
                            maxRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Ø¯Ù…Ø§ (Â°C)',
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        },
                        min: 0,
                        max: 50
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 12
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        min: 0,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        rtl: true,
                        titleFont: {
                            family: 'Tahoma, sans-serif'
                        },
                        bodyFont: {
                            family: 'Tahoma, sans-serif'
                        },
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    updateChart() {
        if (!this.chart || this.data.length === 0) {
            console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            return;
        }
        
        // Ø¢Ø®Ø±ÛŒÙ† 20 Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
        const chartData = this.data.slice(-20);
        console.log(`ğŸ“ˆ Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø§ ${chartData.length} Ø±Ú©ÙˆØ±Ø¯`);
        
        // Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ
        const labels = chartData.map(d => {
            if (d.timestamp) {
                return d.timestamp.split(':').slice(0, 2).join(':'); // Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡
            }
            return '--:--';
        });
        
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª
        const temps = chartData.map(d => d.temperature || 0);
        const hums = chartData.map(d => d.humidity || 0);
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        this.chart.data.labels = labels;
        this.chart.data.datasets[0].data = temps;
        this.chart.data.datasets[1].data = hums;
        
        // ØªÙ†Ø¸ÛŒÙ… min/max Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ©
        if (temps.length > 0) {
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            this.chart.options.scales.y.min = Math.floor(minTemp) - 2;
            this.chart.options.scales.y.max = Math.ceil(maxTemp) + 2;
        }
        
        if (hums.length > 0) {
            const minHum = Math.min(...hums);
            const maxHum = Math.max(...hums);
            this.chart.options.scales.y1.min = Math.floor(minHum) - 5;
            this.chart.options.scales.y1.max = Math.ceil(maxHum) + 5;
        }
        
        this.chart.update('none');
        console.log('âœ… Ù†Ù…ÙˆØ¯Ø§Ø± Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯');
    }

    updateStats() {
        document.getElementById('dataCount').textContent = 
            `Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ${this.data.length}`;
        
        document.getElementById('recordCount').textContent = 
            `${this.totalRecords} Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ`;
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø±Ø® Ø¢Ù¾Ø¯ÛŒØª
        if (this.lastDataTime) {
            const rate = 1000 / this.configRefreshRate || 5000;
            document.getElementById('updateRate').textContent = 
                `${(1000 / rate).toFixed(1)}/s`;
        }
    }

    updateStatus(text, type) {
        const element = document.getElementById('status');
        element.innerHTML = `<i class="bi bi-circle-fill"></i> ${text}`;
        element.className = `badge bg-${type}`;
    }

    startAutoUpdate() {
        // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        this.fetchData();
        
        // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§Ø²Ù‡ Ø¢Ù¾Ø¯ÛŒØª
        this.configRefreshRate = 5000; // Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
        this.updateInterval = setInterval(() => {
            this.fetchData();
        }, this.configRefreshRate);
        
        this.isConnected = true;
        document.getElementById('connectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Ù‚Ø·Ø¹';
        document.getElementById('connectBtn').className = 'btn btn-danger';
    }

    stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        this.isConnected = false;
        document.getElementById('connectBtn').innerHTML = '<i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„';
        document.getElementById('connectBtn').className = 'btn btn-success';
        this.updateStatus('Ù‚Ø·Ø¹', 'secondary');
    }

    toggleConnection() {
        if (this.isConnected) {
            this.stopAutoUpdate();
        } else {
            this.startAutoUpdate();
        }
    }

    restartAutoUpdate() {
        this.stopAutoUpdate();
        this.startAutoUpdate();
    }

    resetData() {
        if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) {
            this.data = [];
            this.totalRecords = 0;
            this.updateTable([]);
            this.updateChart();
            this.updateStats();
            console.log('â™»ï¸ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
        }
    }

    showSampleData() {
        const sampleData = [
            {
                id: this.totalRecords + 1,
                timestamp: new Date().toLocaleTimeString('fa-IR').slice(0, 8),
                temperature: 24.5 + Math.random() * 2,
                humidity: 55 + Math.random() * 5,
                sensor: "AHT20",
                device: "ESP32"
            }
        ];
        this.processData(sampleData);
        document.getElementById('dataTable').innerHTML = 
            '<div class="alert alert-warning">Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯)</div>' +
            this.generateTableHTML(sampleData);
    }

    generateTableHTML(dataArray) {
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§</th>
                            <th>Ø±Ø·ÙˆØ¨Øª</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        dataArray.forEach(item => {
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature?.toFixed(1) || '--'}Â°C</td>
                    <td>${item.humidity?.toFixed(1) || '--'}%</td>
                    <td><span class="badge bg-secondary">${item.id || '--'}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        return html;
    }

    startUptimeCounter() {
        setInterval(() => {
            if (this.lastDataTime) {
                const secondsAgo = Math.floor((new Date() - this.lastDataTime) / 1000);
                if (secondsAgo > 60) {
                    this.updateStatus('Ø¹Ø¯Ù… Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡', 'warning');
                }
            }
        }, 10000);
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new SensorDashboard();
    
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù†Ø³ÙˆÙ„
    console.log('ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Real-Time Ø³Ù†Ø³ÙˆØ± ESP32');
    console.log('ğŸ“ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json');
    console.log('ğŸš€ Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
    
    // ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø±
    setTimeout(() => {
        console.log('ğŸ§ª ØªØ³Øª Ø³ÛŒØ³ØªÙ…...');
        dashboard.fetchData();
    }, 2000);
});
</script>

<!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</body>
</html>
