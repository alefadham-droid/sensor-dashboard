<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Real-Time Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Tahoma', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .card { 
            background: white; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .temp-card { 
            background: linear-gradient(135deg, #ff6b6b, #ffa8a8); 
            color: white; 
        }
        .hum-card { 
            background: linear-gradient(135deg, #4d96ff, #6bc5ff); 
            color: white; 
        }
        .sensor-value { 
            font-size: 3rem; 
            font-weight: bold; 
        }
        .chart-container {
            height: 250px;
            position: relative;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± Ø³Ø§Ø¯Ù‡â€ŒØªØ± -->
    <div class="card bg-primary text-white mb-3">
        <div class="card-body text-center">
            <h1><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
            <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32 + AHT20</p>
            <div>
                <span id="status" class="badge bg-warning">
                    <i class="bi bi-circle-fill"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
                </span>
                <span id="lastUpdate" class="badge bg-info ms-2">
                    <i class="bi bi-clock"></i> 
                    <span id="updateTime">--:--:--</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card temp-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="tempValue">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card hum-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="humValue">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="bi bi-sliders"></i> Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§</h5>
            <div class="row">
                <div class="col-6">
                    <button id="connectBtn" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„
                    </button>
                </div>
                <div class="col-6">
                    <button id="refreshBtn" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-arrow-clockwise"></i> Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
                    </button>
                </div>
            </div>
            <div class="text-center mt-2">
                <span class="badge bg-secondary" id="recordCount">0 Ø±Ú©ÙˆØ±Ø¯</span>
                <span class="badge bg-dark ms-2" id="espTime">ESP: --:--</span>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <div class="row">
        <div class="col-lg-7 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5><i class="bi bi-graph-up"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
                    <div class="chart-container">
                        <canvas id="sensorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-5 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5><i class="bi bi-table"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <div id="dataTable">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                                </div>
                                <p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="card">
        <div class="card-body text-center">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                <span id="totalRecords">0</span> Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ | 
                Ø¢Ù¾Ù„ÙˆØ¯ Ù‡Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡ | 
                <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> Ù…Ø®Ø²Ù†
                </a>
            </small>
        </div>
    </div>
</div>

<script>
class SensorDashboard {
    constructor() {
        this.dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
        this.dataHistory = [];
        this.chart = null;
        this.updateInterval = null;
        this.totalRecords = 0;
        this.isConnected = true;
        
        this.init();
    }

    init() {
        console.log('ğŸš€ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
        
        this.initChart();
        this.setupEventListeners();
        this.updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...', 'warning');
        
        this.fetchData();
        this.startAutoUpdate();
    }

    setupEventListeners() {
        // Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„/Ù‚Ø·Ø¹
        const connectBtn = document.getElementById('connectBtn');
        if (connectBtn) {
            connectBtn.addEventListener('click', () => {
                if (this.isConnected) {
                    this.stopAutoUpdate();
                    connectBtn.innerHTML = '<i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„';
                    connectBtn.className = 'btn btn-success w-100 mb-2';
                    this.updateStatus('Ù‚Ø·Ø¹ Ø´Ø¯Ù‡', 'secondary');
                } else {
                    this.startAutoUpdate();
                    connectBtn.innerHTML = '<i class="bi bi-plug-fill"></i> Ù‚Ø·Ø¹';
                    connectBtn.className = 'btn btn-danger w-100 mb-2';
                    this.updateStatus('Ù…ØªØµÙ„', 'success');
                }
            });
        }

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.fetchData();
                this.updateStatus('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ...', 'info');
            });
        }

        // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                this.fetchData();
            }
            if (e.key === ' ') {
                e.preventDefault();
                if (connectBtn) connectBtn.click();
            }
        });
    }

    async fetchData() {
        try {
            console.log('ğŸ”„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡...');
            
            const timestamp = Date.now();
            const url = `${this.dataUrl}?t=${timestamp}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('âœ… Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
            
            this.processData(data);
            this.updateStatus('Ù…ØªØµÙ„', 'success');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
            this.updateStatus('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„', 'danger');
        }
    }

    processData(rawData) {
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
        
        if (dataArray.length === 0) {
            console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            return;
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        dataArray.forEach(newItem => {
            const exists = this.dataHistory.some(item => item.id === newItem.id);
            if (!exists) {
                this.dataHistory.push(newItem);
                this.totalRecords++;
            }
        });
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.dataHistory.length > 50) {
            this.dataHistory = this.dataHistory.slice(-50);
        }
        
        // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
        const latest = dataArray[dataArray.length - 1];
        console.log('ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯:', latest);
        
        // Ø¢Ù¾Ø¯ÛŒØª UI
        this.updateUI(latest);
        this.updateTable();
        this.updateChart();
        this.updateStats();
    }

    updateUI(latest) {
        // Ø¯Ù…Ø§
        const tempElement = document.getElementById('tempValue');
        if (tempElement && latest.temperature !== undefined) {
            tempElement.textContent = latest.temperature.toFixed(1);
        }
        
        // Ø±Ø·ÙˆØ¨Øª
        const humElement = document.getElementById('humValue');
        if (humElement && latest.humidity !== undefined) {
            humElement.textContent = latest.humidity.toFixed(1);
        }
        
        // Ø²Ù…Ø§Ù†
        const timeElement = document.getElementById('updateTime');
        if (timeElement) {
            timeElement.textContent = new Date().toLocaleTimeString('fa-IR');
        }
        
        // Ø²Ù…Ø§Ù† ESP32
        const espTimeElement = document.getElementById('espTime');
        if (espTimeElement && latest.timestamp) {
            espTimeElement.textContent = 'ESP: ' + latest.timestamp.split(':').slice(0, 2).join(':');
        }
    }

    updateTable() {
        const tableContainer = document.getElementById('dataTable');
        if (!tableContainer) return;
        
        const recentData = this.dataHistory.slice(-8).reverse();
        
        if (recentData.length === 0) {
            tableContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                    </div>
                </div>
            `;
            return;
        }
        
        let html = `
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>Ø²Ù…Ø§Ù†</th>
                        <th>Ø¯Ù…Ø§</th>
                        <th>Ø±Ø·ÙˆØ¨Øª</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        recentData.forEach((item) => {
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature !== undefined ? item.temperature.toFixed(1) + 'Â°C' : '--'}</td>
                    <td>${item.humidity !== undefined ? item.humidity.toFixed(1) + '%' : '--'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        tableContainer.innerHTML = html;
    }

    initChart() {
        const ctx = document.getElementById('sensorChart');
        if (!ctx) return;
        
        this.chart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ø¯Ù…Ø§ (Â°C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                        data: [],
                        borderColor: '#4d96ff',
                        backgroundColor: 'rgba(77, 150, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 11
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                family: 'Tahoma, sans-serif'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    updateChart() {
        if (!this.chart || this.dataHistory.length === 0) return;
        
        const chartData = this.dataHistory.slice(-20);
        
        const labels = chartData.map(d => {
            if (d.timestamp) {
                const parts = d.timestamp.split(':');
                return parts[0] + ':' + parts[1];
            }
            return '--:--';
        });
        
        const temps = chartData.map(d => d.temperature || 0);
        const hums = chartData.map(d => d.humidity || 0);
        
        this.chart.data.labels = labels;
        this.chart.data.datasets[0].data = temps;
        this.chart.data.datasets[1].data = hums;
        this.chart.update('none');
    }

    updateStats() {
        // Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§
        const recordElement = document.getElementById('recordCount');
        if (recordElement) {
            recordElement.textContent = this.dataHistory.length + ' Ø±Ú©ÙˆØ±Ø¯';
        }
        
        // Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§
        const totalElement = document.getElementById('totalRecords');
        if (totalElement) {
            totalElement.textContent = this.totalRecords;
        }
    }

    updateStatus(text, type) {
        const element = document.getElementById('status');
        if (element) {
            element.innerHTML = `<i class="bi bi-circle-fill"></i> ${text}`;
            element.className = `badge bg-${type}`;
        }
    }

    startAutoUpdate() {
        this.isConnected = true;
        this.updateInterval = setInterval(() => {
            this.fetchData();
        }, 5000);
        
        console.log('ğŸ”„ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯');
    }

    stopAutoUpdate() {
        this.isConnected = false;
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        console.log('â¹ï¸ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯');
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new SensorDashboard();
    console.log('ğŸ‰ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
});
</script>
</body>
</html>
