<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32 - Real-Time</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Vazir', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 15px;
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }
        
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
        }
        
        .status-card {
            background: linear-gradient(135deg, #38b000 0%, #70e000 100%);
            color: white;
        }
        
        .data-card {
            background: white;
            color: var(--dark);
        }
        
        .sensor-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .unit {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .last-update {
            font-size: 0.85rem;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status-badge {
            padding: 6px 18px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .online {
            background: #28a745;
            color: white;
            animation: pulse-online 2s infinite;
        }
        
        .offline {
            background: #dc3545;
            color: white;
        }
        
        @keyframes pulse-online {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        table {
            font-size: 0.9rem;
        }
        
        table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .refresh-btn {
            background: var(--primary);
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .refresh-btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        
        .refresh-btn:active {
            transform: scale(0.98);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .data-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .time-ago {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .sensor-value {
                font-size: 2.2rem;
            }
            
            body {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ù‡Ø¯Ø± -->
        <div class="card header-card">
            <div class="card-body text-center">
                <h1 class="mb-3"><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
                <p class="mb-0">
                    <i class="bi bi-cpu"></i> Ø³Ù†Ø³ÙˆØ± AHT20 | 
                    <span id="updateIntervalText">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡</span>
                </p>
                <div class="mt-3">
                    <button id="refreshBtn" class="refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÛŒ
                    </button>
                    <span id="lastUpdate" class="last-update ms-3">
                        <i class="bi bi-clock"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
                    </span>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
        <div class="row">
            <div class="col-md-4">
                <div class="card temp-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentTemp">--</div>
                        <div class="unit">Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxTemp">--</span>Â°C</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minTemp">--</span>Â°C</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card hum-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentHum">--</div>
                        <div class="unit">Ø¯Ø±ØµØ¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxHum">--</span>%</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minHum">--</span>%</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-info-circle"></i> ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</h5>
                        <div class="mt-4">
                            <div class="mb-3">
                                <h6>ÙˆØ¶Ø¹ÛŒØª ESP32</h6>
                                <span id="deviceStatus" class="status-badge offline">Ù†Ø§Ù…Ø´Ø®Øµ</span>
                            </div>
                            <div class="mb-3">
                                <h6>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h6>
                                <div class="data-count" id="dataCount">0</div>
                            </div>
                            <div>
                                <h6>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</h6>
                                <div id="lastDataTime">--:--:--</div>
                                <div class="time-ago" id="timeAgo">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div class="card data-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="chartAutoUpdate" checked>
                        <label class="form-check-label" for="chartAutoUpdate">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ù…ÙˆØ¯Ø§Ø±</label>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
                <div id="chartLoading" class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
        <div class="card data-card">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-table"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¢Ø®Ø±ÛŒÙ† 10 Ù…ÙˆØ±Ø¯)</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø²Ù…Ø§Ù†</th>
                                <th>Ø¯Ù…Ø§ (Â°C)</th>
                                <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                                <th>Ø³Ù†Ø³ÙˆØ±</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´Ù† -->
                            <tr id="noDataRow">
                                <td colspan="6" class="text-center py-4">
                                    <div class="no-data">
                                        <i class="bi bi-database-exclamation"></i>
                                        <p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                                        <small>Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ESP32...</small>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÙÙˆØªØ± -->
        <div class="text-center mt-4">
            <div class="card data-card">
                <div class="card-body">
                    <p class="mb-0">
                        <i class="bi bi-github"></i> 
                        <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank">
                            Ù…Ø®Ø²Ù† GitHub
                        </a>
                        | 
                        <i class="bi bi-cpu"></i>
                        ESP32 + AHT20 | 
                        <i class="bi bi-arrow-repeat"></i>
                        <span id="refreshRate">Ø±ÙØ±Ø´: 5s</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ============
        let sensorChart = null;
        let sensorData = [];
        let autoRefreshInterval = 5000; // 5 Ø«Ø§Ù†ÛŒÙ‡
        let refreshIntervalId = null;
        let lastFetchTime = 0;
        
        // ============ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ============
        const DATA_URL = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
        const CACHE_DURATION = 10000; // 10 Ø«Ø§Ù†ÛŒÙ‡ Ú©Ø´
        const OFFLINE_THRESHOLD = 300000; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡ (300000ms)
        
        // ============ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ============
        
        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        async function loadSensorData() {
            try {
                console.log('ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...');
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ù…Ø±ÙˆØ±Ú¯Ø±
                const timestamp = new Date().getTime();
                const cacheBuster = lastFetchTime > 0 ? `&t=${timestamp}` : `?t=${timestamp}`;
                
                const response = await fetch(DATA_URL + cacheBuster, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                lastFetchTime = Date.now();
                
                console.log(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (${data.length} Ø±Ú©ÙˆØ±Ø¯)`);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                processData(data);
                
                // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
                updateLastUpdateTime();
                
                return true;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                updateDeviceStatus(false);
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-danger">
                                <i class="bi bi-wifi-off"></i>
                                <p>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</p>
                                <small>${error.message}</small>
                            </div>
                        </td>
                    </tr>
                `;
                
                return false;
            }
        }
        
        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function processData(data) {
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³Øª
            if (!Array.isArray(data)) {
                console.warn('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³ØªÙ†Ø¯:', data);
                sensorData = [];
                return;
            }
            
            sensorData = data;
            
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…
            if (sensorData.length === 0) {
                document.getElementById('noDataRow').style.display = '';
                document.getElementById('deviceStatus').textContent = 'Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡';
                document.getElementById('deviceStatus').className = 'status-badge offline';
                return;
            }
            
            // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ "Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡"
            document.getElementById('noDataRow').style.display = 'none';
            
            // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
            sensorData.sort((a, b) => {
                if (a.id && b.id) return b.id - a.id;
                if (a.unix_time && b.unix_time) return b.unix_time - a.unix_time;
                return 0;
            });
            
            // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
            updateCards();
            
            // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø± (Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ù‡)
            if (document.getElementById('chartAutoUpdate').checked) {
                updateChart();
            }
            
            // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
            updateTable();
            
            // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
            updateDeviceStatus(true);
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
        function updateCards() {
            const latest = sensorData[0];
            
            // Ù…Ù‚Ø§Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
            if (latest.temperature !== undefined) {
                document.getElementById('currentTemp').textContent = latest.temperature.toFixed(1);
            }
            
            if (latest.humidity !== undefined) {
                document.getElementById('currentHum').textContent = latest.humidity.toFixed(1);
            }
            
            // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡
            if (latest.timestamp) {
                document.getElementById('lastDataTime').textContent = latest.timestamp;
                updateTimeAgo(latest.unix_time);
            }
            
            // ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            document.getElementById('dataCount').textContent = sensorData.length;
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ min/max
            updateMinMaxValues();
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        function updateChart() {
            // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯
            document.getElementById('chartLoading').style.display = 'none';
            
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…
            if (sensorData.length < 2) {
                if (sensorChart) {
                    sensorChart.destroy();
                    sensorChart = null;
                }
                return;
            }
            
            // ÙÙ‚Ø· 15 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø± Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ (Ù…Ø¹Ú©ÙˆØ³ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±)
            const chartData = sensorData.slice(0, 15).reverse();
            
            const labels = chartData.map(d => {
                if (d.timestamp) return d.timestamp;
                if (d.id) return `#${d.id}`;
                return '';
            });
            
            const temps = chartData.map(d => d.temperature || 0);
            const hums = chartData.map(d => d.humidity || 0);
            
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            // Ø§Ú¯Ø± Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡ØŒ Ø¢Ù¾Ø¯ÛŒØªØ´ Ú©Ù†
            if (sensorChart) {
                sensorChart.data.labels = labels;
                sensorChart.data.datasets[0].data = temps;
                sensorChart.data.datasets[1].data = hums;
                sensorChart.update('quiet'); // Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¯ÙˆÙ† Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
                return;
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¬Ø¯ÛŒØ¯
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø¯Ù…Ø§ (Â°C)',
                            data: temps,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            data: hums,
                            borderColor: '#4d96ff',
                            backgroundColor: 'rgba(77, 150, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                font: {
                                    family: 'Vazir'
                                }
                            }
                        },
                        tooltip: {
                            rtl: true,
                            titleFont: {
                                family: 'Vazir'
                            },
                            bodyFont: {
                                family: 'Vazir'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    family: 'Vazir'
                                },
                                maxRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                font: {
                                    family: 'Vazir'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    animation: {
                        duration: 500 // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ú©ÙˆØªØ§Ù‡â€ŒØªØ±
                    }
                }
            });
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            
            // ÙÙ‚Ø· 10 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø± Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
            const displayData = sensorData.slice(0, 10);
            
            let tableHTML = '';
            
            displayData.forEach((item, index) => {
                // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù…Ø§
                let tempColor = 'success';
                if (item.temperature > 30) tempColor = 'danger';
                else if (item.temperature > 25) tempColor = 'warning';
                
                // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ø·ÙˆØ¨Øª
                let humColor = 'success';
                if (item.humidity > 80) humColor = 'danger';
                else if (item.humidity > 60) humColor = 'warning';
                
                tableHTML += `
                    <tr>
                        <td>${item.id || index + 1}</td>
                        <td>${item.timestamp || '--:--:--'}</td>
                        <td>
                            <span class="badge bg-${tempColor}">
                                ${item.temperature ? item.temperature.toFixed(1) : '--'}Â°C
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-${humColor}">
                                ${item.humidity ? item.humidity.toFixed(1) : '--'}%
                            </span>
                        </td>
                        <td>${item.sensor || 'AHT20'}</td>
                        <td>
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i>
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ø³ØªÚ¯Ø§Ù‡
        function updateDeviceStatus(online) {
            const statusEl = document.getElementById('deviceStatus');
            
            if (online && sensorData.length > 0) {
                const latest = sensorData[0];
                const latestTime = latest.unix_time || 0;
                const currentTime = Math.floor(Date.now() / 1000);
                const isRecentlyOnline = (currentTime - latestTime) < 300; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡
                
                if (isRecentlyOnline) {
                    statusEl.className = 'status-badge online';
                    statusEl.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
                } else {
                    statusEl.className = 'status-badge offline';
                    statusEl.textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ† (Ù‚Ø¯ÛŒÙ…ÛŒ)';
                }
            } else {
                statusEl.className = 'status-badge offline';
                statusEl.textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†';
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª min/max
        function updateMinMaxValues() {
            const temps = sensorData.map(d => d.temperature).filter(t => t != null);
            const hums = sensorData.map(d => d.humidity).filter(h => h != null);
            
            if (temps.length > 0) {
                document.getElementById('maxTemp').textContent = Math.max(...temps).toFixed(1);
                document.getElementById('minTemp').textContent = Math.min(...temps).toFixed(1);
            }
            
            if (hums.length > 0) {
                document.getElementById('maxHum').textContent = Math.max(...hums).toFixed(1);
                document.getElementById('minHum').textContent = Math.min(...hums).toFixed(1);
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† "Ú†Ù†Ø¯ ÙˆÙ‚Øª Ù¾ÛŒØ´"
        function updateTimeAgo(unixTime) {
            if (!unixTime) return;
            
            const now = Math.floor(Date.now() / 1000);
            const diff = now - unixTime;
            
            let timeAgo = '';
            
            if (diff < 60) {
                timeAgo = `${diff} Ø«Ø§Ù†ÛŒÙ‡ Ù¾ÛŒØ´`;
            } else if (diff < 3600) {
                timeAgo = `${Math.floor(diff / 60)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´`;
            } else if (diff < 86400) {
                timeAgo = `${Math.floor(diff / 3600)} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´`;
            } else {
                timeAgo = `${Math.floor(diff / 86400)} Ø±ÙˆØ² Ù¾ÛŒØ´`;
            }
            
            document.getElementById('timeAgo').textContent = timeAgo;
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('fa-IR');
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="bi bi-clock"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${timeStr}`;
        }
        
        // Ø´Ø±ÙˆØ¹ Auto-Refresh
        function startAutoRefresh() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† interval Ù‚Ø¨Ù„ÛŒ
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            
            // ØªÙ†Ø¸ÛŒÙ… interval Ø¬Ø¯ÛŒØ¯
            refreshIntervalId = setInterval(() => {
                loadSensorData();
            }, autoRefreshInterval);
            
            // Ø¢Ù¾Ø¯ÛŒØª Ù…ØªÙ†
            const seconds = autoRefreshInterval / 1000;
            document.getElementById('refreshRate').textContent = `Ø±ÙØ±Ø´: ${seconds}s`;
            document.getElementById('updateIntervalText').textContent = `Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± ${seconds} Ø«Ø§Ù†ÛŒÙ‡`;
        }
        
        // ØªÙˆÙ‚Ù Auto-Refresh
        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }
        
        // ØªØºÛŒÛŒØ± Ø³Ø±Ø¹Øª Ø±ÙØ±Ø´
        function changeRefreshSpeed(seconds) {
            autoRefreshInterval = seconds * 1000;
            startAutoRefresh();
            
            // Ù†Ù…Ø§ÛŒØ´ toast ÛŒØ§ Ù¾ÛŒØ§Ù…
            showMessage(`Ø³Ø±Ø¹Øª Ø±ÙØ±Ø´ Ø¨Ù‡ ${seconds} Ø«Ø§Ù†ÛŒÙ‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯`);
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        function showMessage(message) {
            // Ø§ÛŒØ¬Ø§Ø¯ toast Ø³Ø§Ø¯Ù‡
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 m-3 p-3 bg-primary text-white rounded shadow';
            toast.style.zIndex = '1050';
            toast.innerHTML = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // ============ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ============
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadSensorData();
            showMessage('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
        });
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ø³Ø±Ø¹Øª Ø±ÙØ±Ø´ (Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        changeRefreshSpeed(2);
                        break;
                    case '2':
                        changeRefreshSpeed(5);
                        break;
                    case '3':
                        changeRefreshSpeed(10);
                        break;
                    case '0':
                        if (refreshIntervalId) {
                            stopAutoRefresh();
                            showMessage('Auto-Refresh Ù…ØªÙˆÙ‚Ù Ø´Ø¯');
                        } else {
                            startAutoRefresh();
                            showMessage('Auto-Refresh Ø´Ø±ÙˆØ¹ Ø´Ø¯');
                        }
                        break;
                }
            }
        });
        
        // ============ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ============
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯...');
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            loadSensorData();
            
            // Ø´Ø±ÙˆØ¹ Auto-Refresh
            startAutoRefresh();
            
            // ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
            document.getElementById('chartAutoUpdate').addEventListener('change', function() {
                if (this.checked && sensorData.length > 1) {
                    updateChart();
                }
            });
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø³Ø±Ø¹Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            createSpeedControls();
        });
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø³Ø±Ø¹Øª
        function createSpeedControls() {
            const controls = document.createElement('div');
            controls.className = 'position-fixed bottom-0 start-0 m-3';
            controls.style.zIndex = '1000';
            
            controls.innerHTML = `
                <div class="btn-group btn-group-sm shadow">
                    <button class="btn btn-outline-primary" onclick="changeRefreshSpeed(2)">2s</button>
                    <button class="btn btn-outline-primary" onclick="changeRefreshSpeed(5)">5s</button>
                    <button class="btn btn-outline-primary" onclick="changeRefreshSpeed(10)">10s</button>
                    <button class="btn btn-outline-primary" onclick="changeRefreshSpeed(30)">30s</button>
                </div>
            `;
            
            document.body.appendChild(controls);
        }
        
        // Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù† ØªÙˆØ§Ø¨Ø¹ Ø¯Ø± scope Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² onclick
        window.changeRefreshSpeed = changeRefreshSpeed;
        
    </script>

    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</body>
</html>
