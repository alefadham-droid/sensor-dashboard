<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f8f9fa; padding: 15px; }
        .card { border-radius: 10px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .temp-card { background: linear-gradient(135deg, #ff6b6b, #ffa8a8); color: white; }
        .hum-card { background: linear-gradient(135deg, #4d96ff, #6bc5ff); color: white; }
        .sensor-value { font-size: 3rem; font-weight: bold; }
        .status-badge { font-size: 0.8rem; }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± -->
    <div class="card bg-primary text-white mb-3">
        <div class="card-body text-center">
            <h1><i class="bi bi-graph-up"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
            <p>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Real-Time Ø§Ø² ESP32 + AHT20</p>
            <div class="status-badge">
                <span id="status" class="badge bg-warning">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
                <span id="lastUpdate" class="badge bg-info">Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª: --:--:--</span>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card temp-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="tempValue">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card hum-card">
                <div class="card-body text-center">
                    <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                    <div class="sensor-value" id="humValue">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="bi bi-table"></i> Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
            <div id="dataTable" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <div class="card">
        <div class="card-body">
            <h5><i class="bi bi-bar-chart"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
            <canvas id="sensorChart" height="150"></canvas>
        </div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="card mt-3">
        <div class="card-body">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ | 
                <span id="recordCount">0 Ø±Ú©ÙˆØ±Ø¯</span> | 
                <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank">Ù…Ø®Ø²Ù† GitHub</a>
            </small>
        </div>
    </div>
</div>

<script>
class SensorDashboard {
    constructor() {
        this.dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
        this.data = [];
        this.chart = null;
        this.updateInterval = null;
        this.retryCount = 0;
        
        this.init();
    }

    init() {
        this.initChart();
        this.startAutoUpdate();
        this.updateStatus('ğŸ”µ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...', 'info');
    }

    async fetchData() {
        try {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´
            const timestamp = Date.now();
            const url = `${this.dataUrl}?t=${timestamp}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const jsonData = await response.json();
            
            // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª (Ø¢Ø±Ø§ÛŒÙ‡ Ùˆ ØªÚ© Ø±Ú©ÙˆØ±Ø¯)
            const dataArray = Array.isArray(jsonData) ? jsonData : [jsonData];
            
            this.processData(dataArray);
            this.retryCount = 0;
            this.updateStatus('ğŸŸ¢ Ù…ØªØµÙ„', 'success');
            
        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
            this.retryCount++;
            
            if (this.retryCount > 3) {
                this.updateStatus('ğŸ”´ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„', 'danger');
                this.showSampleData();
            } else {
                this.updateStatus('ğŸŸ¡ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...', 'warning');
            }
        }
    }

    processData(dataArray) {
        if (!dataArray || dataArray.length === 0) return;
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this.data = [...this.data, ...dataArray].slice(-20);
        
        // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
        const latest = dataArray[dataArray.length - 1];
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ±
        document.getElementById('tempValue').textContent = 
            latest.temperature?.toFixed(1) || '--';
        document.getElementById('humValue').textContent = 
            latest.humidity?.toFixed(1) || '--';
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
            `Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª: ${now.toLocaleTimeString('fa-IR')}`;
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
        this.updateTable(dataArray.slice(-5).reverse());
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        this.updateChart();
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
        document.getElementById('recordCount').textContent = 
            `${this.data.length} Ø±Ú©ÙˆØ±Ø¯`;
    }

    updateTable(dataArray) {
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§</th>
                            <th>Ø±Ø·ÙˆØ¨Øª</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        dataArray.forEach(item => {
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature?.toFixed(1) || '--'}Â°C</td>
                    <td>${item.humidity?.toFixed(1) || '--'}%</td>
                    <td><span class="badge bg-secondary">${item.id || '--'}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('dataTable').innerHTML = html;
    }

    initChart() {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ø¯Ù…Ø§ (Â°C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                        data: [],
                        borderColor: '#4d96ff',
                        backgroundColor: 'rgba(77, 150, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            font: {
                                family: 'Tahoma, sans-serif'
                            }
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            font: {
                                family: 'Tahoma, sans-serif'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                family: 'Tahoma, sans-serif',
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    updateChart() {
        if (!this.chart || this.data.length === 0) return;
        
        const chartData = this.data.slice(-15);
        
        this.chart.data.labels = chartData.map(d => 
            d.timestamp?.split(':').slice(0, 2).join(':') || '--:--'
        );
        
        this.chart.data.datasets[0].data = chartData.map(d => d.temperature || 0);
        this.chart.data.datasets[1].data = chartData.map(d => d.humidity || 0);
        
        this.chart.update('none');
    }

    startAutoUpdate() {
        // Ø§ÙˆÙ„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù†
        this.fetchData();
        
        // Ø³Ù¾Ø³ Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
        this.updateInterval = setInterval(() => {
            this.fetchData();
        }, 10000);
    }

    updateStatus(text, type) {
        const element = document.getElementById('status');
        element.textContent = text;
        element.className = `badge bg-${type}`;
    }

    showSampleData() {
        const sampleData = [
            {
                id: this.data.length + 1,
                timestamp: new Date().toLocaleTimeString('fa-IR').slice(0, 8),
                temperature: 24.5,
                humidity: 55.0,
                sensor: "AHT20",
                device: "ESP32"
            }
        ];
        this.processData(sampleData);
        document.getElementById('dataTable').innerHTML = 
            '<div class="alert alert-warning">Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯)</div>' +
            this.generateTableHTML(sampleData);
    }

    generateTableHTML(dataArray) {
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§</th>
                            <th>Ø±Ø·ÙˆØ¨Øª</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        dataArray.forEach(item => {
            html += `
                <tr>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td>${item.temperature?.toFixed(1) || '--'}Â°C</td>
                    <td>${item.humidity?.toFixed(1) || '--'}%</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        return html;
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new SensorDashboard();
    
    // Ú©Ù„ÛŒØ¯ R Ø¨Ø±Ø§ÛŒ refresh Ø¯Ø³ØªÛŒ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'r' || e.key === 'R') {
            dashboard.fetchData();
        }
    });
    
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù†Ø³ÙˆÙ„
    console.log('ğŸš€ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
    console.log('ğŸ“Š Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json');
});
</script>
</body>
</html>
