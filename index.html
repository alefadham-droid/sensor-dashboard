<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
        }
        
        body {
            font-family: 'Vazir', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .header-card {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
        }
        
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }
        
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
        }
        
        .avg-card {
            background: linear-gradient(135deg, #38b000 0%, #70e000 100%);
            color: white;
        }
        
        .status-card {
            background: linear-gradient(135deg, #7209b7 0%, #9d4edd 100%);
            color: white;
        }
        
        .sensor-value {
            font-size: 3.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .unit {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .avg-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .connection-status {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
        }
        
        .connection-online {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 2px solid #28a745;
        }
        
        .connection-offline {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 2px solid #dc3545;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .table th {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
        }
        
        @media (max-width: 768px) {
            .sensor-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ù‡Ø¯Ø± -->
        <div class="card header-card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2"><i class="bi bi-graph-up-arrow"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø³Ù†Ø³ÙˆØ± ESP32</h1>
                        <p class="mb-0">
                            <i class="bi bi-cpu"></i> Ø³Ù†Ø³ÙˆØ± AHT20 | 
                            <i class="bi bi-wifi"></i> Real-Time Data | 
                            <i class="bi bi-github"></i> GitHub Storage
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="refreshBtn" class="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                        </button>
                        <div id="lastUpdate" class="text-white mt-2">
                            <i class="bi bi-clock"></i> <small>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</small>
                        </div>
                    </div>
                </div>
                <!-- ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator" id="statusIndicator"></div>
                            <span id="connectionStatus" class="connection-status connection-offline">
                                Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
                            </span>
                            <div class="ms-3 text-white">
                                <span id="timeAgo">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card temp-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-thermometer-half"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentTemp">--</div>
                        <div class="unit">Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxTemp">--</span>Â°C</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minTemp">--</span>Â°C</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card hum-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-moisture"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h5>
                        <div class="sensor-value" id="currentHum">--</div>
                        <div class="unit">Ø¯Ø±ØµØ¯</div>
                        <div class="mt-3">
                            <small>Ø­Ø¯Ø§Ú©Ø«Ø±: <span id="maxHum">--</span>%</small> | 
                            <small>Ø­Ø¯Ø§Ù‚Ù„: <span id="minHum">--</span>%</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card avg-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-calculator"></i> Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§</h5>
                        <div class="avg-value" id="avgTemp">--</div>
                        <div class="unit">Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                        <div class="mt-3">
                            <small>Ø¯Ø± Û± Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-activity"></i> ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</h5>
                        <div class="mt-3">
                            <div class="mb-2">
                                <h6>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</h6>
                                <div id="lastDataTime">--:--:--</div>
                            </div>
                            <div class="mb-2">
                                <h6>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h6>
                                <div class="sensor-value" style="font-size: 2rem;" id="dataCount">0</div>
                            </div>
                            <div>
                                <h6>Ù‚Ø·Ø¹â€ŒØ´Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§</h6>
                                <div id="disconnectCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-graph-up"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª</h5>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-table"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¢Ø®Ø±ÛŒÙ† Û±Û° Ù…ÙˆØ±Ø¯)</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø²Ù…Ø§Ù†</th>
                                <th>Ø¯Ù…Ø§ (Â°C)</th>
                                <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ============
        let sensorChart = null;
        let sensorData = [];
        let refreshInterval = null;
        let lastSuccessfulFetch = null;
        let disconnectCount = 0;
        let isOnline = false;
        
        // ============ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ============
        
        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ jsDelivr (Ø­Ù„ CORS)
        async function loadSensorData() {
            try {
                console.log('ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...');
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² jsDelivr CDN Ú©Ù‡ Ù…Ø´Ú©Ù„ CORS Ù†Ø¯Ø§Ø±Ø¯
                const dataUrl = 'https://cdn.jsdelivr.net/gh/alefadham-droid/sensor-dashboard/data/sensor-data.json';
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ù…Ø±ÙˆØ±Ú¯Ø±
                const cacheBuster = `?t=${Date.now()}`;
                
                const response = await fetch(dataUrl + cacheBuster, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                lastSuccessfulFetch = Date.now();
                
                console.log(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (${Array.isArray(data) ? data.length : 0} Ø±Ú©ÙˆØ±Ø¯)`);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                processData(data);
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†
                updateConnectionStatus('online');
                
                // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
                updateLastUpdateTime();
                
                return true;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¢ÙÙ„Ø§ÛŒÙ†
                updateConnectionStatus('offline');
                
                // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù‚Ø·Ø¹ÛŒ
                if (isOnline) {
                    disconnectCount++;
                    isOnline = false;
                    updateDisconnectCount();
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
                showErrorMessage(error);
                
                return false;
            }
        }
        
        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function processData(data) {
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³Øª
            if (!Array.isArray(data)) {
                console.warn('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³ØªÙ†Ø¯:', data);
                showNoDataMessage();
                return;
            }
            
            sensorData = data;
            
            // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…
            if (sensorData.length === 0) {
                showNoDataMessage();
                return;
            }
            
            // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ unix_time ÛŒØ§ id
            sensorData.sort((a, b) => {
                const timeA = a.unix_time || a.id || 0;
                const timeB = b.unix_time || b.id || 0;
                return timeB - timeA;
            });
            
            // Ø¢Ù¾Ø¯ÛŒØª ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§
            updateCurrentValues();
            updateAverages();
            updateChart();
            updateTable();
            updateMinMaxValues();
            
            // Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            document.getElementById('dataCount').textContent = sensorData.length;
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
        function updateCurrentValues() {
            const latest = sensorData[0];
            
            // Ø¯Ù…Ø§
            if (latest.temperature !== undefined) {
                const temp = latest.temperature.toFixed(1);
                document.getElementById('currentTemp').textContent = temp;
                document.getElementById('currentTemp').style.color = getTemperatureColor(latest.temperature);
            }
            
            // Ø±Ø·ÙˆØ¨Øª
            if (latest.humidity !== undefined) {
                const hum = latest.humidity.toFixed(1);
                document.getElementById('currentHum').textContent = hum;
                document.getElementById('currentHum').style.color = getHumidityColor(latest.humidity);
            }
            
            // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡
            if (latest.timestamp) {
                document.getElementById('lastDataTime').textContent = latest.timestamp;
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†â€ŒÙ‡Ø§
        function updateAverages() {
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§ (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ 1 Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡)
            const oneHourAgo = Date.now() / 1000 - 3600;
            const recentTemps = sensorData
                .filter(d => (d.unix_time || 0) > oneHourAgo && d.temperature)
                .map(d => d.temperature);
            
            if (recentTemps.length > 0) {
                const avgTemp = recentTemps.reduce((a, b) => a + b, 0) / recentTemps.length;
                document.getElementById('avgTemp').textContent = avgTemp.toFixed(1);
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        function updateChart() {
            if (sensorData.length < 2) {
                // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªØŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
                if (sensorChart) {
                    sensorChart.destroy();
                    sensorChart = null;
                }
                return;
            }
            
            // ÙÙ‚Ø· 20 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø±
            const chartData = sensorData.slice(0, 20).reverse();
            
            const labels = chartData.map(d => d.timestamp || `#${d.id || ''}`);
            const temps = chartData.map(d => d.temperature || 0);
            const hums = chartData.map(d => d.humidity || 0);
            
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            if (sensorChart) {
                // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
                sensorChart.data.labels = labels;
                sensorChart.data.datasets[0].data = temps;
                sensorChart.data.datasets[1].data = hums;
                sensorChart.update('quiet');
            } else {
                // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¬Ø¯ÛŒØ¯
                sensorChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Ø¯Ù…Ø§ (Â°C)',
                                data: temps,
                                borderColor: '#ff6b6b',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                                data: hums,
                                borderColor: '#4d96ff',
                                backgroundColor: 'rgba(77, 150, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                rtl: true
                            }
                        }
                    }
                });
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÙˆÙ„
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            
            // ÙÙ‚Ø· 10 Ø¯Ø§Ø¯Ù‡ Ø¢Ø®Ø±
            const displayData = sensorData.slice(0, 10);
            
            let tableHTML = '';
            
            displayData.forEach((item, index) => {
                // ØªØ´Ø®ÛŒØµ ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ø¯ÛŒÙ
                const rowStatus = getRowStatus(item.unix_time);
                
                tableHTML += `
                    <tr>
                        <td>${item.id || index + 1}</td>
                        <td>${item.timestamp || '--:--:--'}</td>
                        <td>${item.temperature ? item.temperature.toFixed(1) : '--'}</td>
                        <td>${item.humidity ? item.humidity.toFixed(1) : '--'}</td>
                        <td>
                            <span class="badge bg-${rowStatus.color}">
                                ${rowStatus.text}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const statusElement = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'online':
                    indicator.className = 'status-indicator status-online';
                    statusElement.className = 'connection-status connection-online';
                    statusElement.innerHTML = '<i class="bi bi-wifi"></i> Ø¢Ù†Ù„Ø§ÛŒÙ†';
                    isOnline = true;
                    
                    // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡
                    if (sensorData.length > 0) {
                        const lastTime = sensorData[0].unix_time;
                        if (lastTime) {
                            const timeAgo = calculateTimeAgo(lastTime);
                            document.getElementById('timeAgo').textContent = `${timeAgo} Ù¾ÛŒØ´`;
                        }
                    }
                    break;
                    
                case 'offline':
                    indicator.className = 'status-indicator status-offline';
                    statusElement.className = 'connection-status connection-offline';
                    statusElement.innerHTML = '<i class="bi bi-wifi-off"></i> Ø¢ÙÙ„Ø§ÛŒÙ†';
                    isOnline = false;
                    break;
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª min/max
        function updateMinMaxValues() {
            const temps = sensorData.map(d => d.temperature).filter(t => t != null);
            const hums = sensorData.map(d => d.humidity).filter(h => h != null);
            
            if (temps.length > 0) {
                document.getElementById('maxTemp').textContent = Math.max(...temps).toFixed(1);
                document.getElementById('minTemp').textContent = Math.min(...temps).toFixed(1);
            }
            
            if (hums.length > 0) {
                document.getElementById('maxHum').textContent = Math.max(...hums).toFixed(1);
                document.getElementById('minHum').textContent = Math.min(...hums).toFixed(1);
            }
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù‚Ø·Ø¹ÛŒ
        function updateDisconnectCount() {
            document.getElementById('disconnectCount').textContent = disconnectCount;
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('fa-IR');
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="bi bi-clock"></i> <small>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${timeStr}</small>`;
        }
        
        // ============ ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ============
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡
        function calculateTimeAgo(unixTime) {
            if (!unixTime) return '--';
            
            const now = Math.floor(Date.now() / 1000);
            const diff = now - unixTime;
            
            if (diff < 60) {
                return `${diff} Ø«Ø§Ù†ÛŒÙ‡`;
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)} Ø¯Ù‚ÛŒÙ‚Ù‡`;
            } else if (diff < 86400) {
                return `${Math.floor(diff / 3600)} Ø³Ø§Ø¹Øª`;
            } else {
                return `${Math.floor(diff / 86400)} Ø±ÙˆØ²`;
            }
        }
        
        // Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù…Ø§
        function getTemperatureColor(temp) {
            if (temp < 20) return '#4d96ff'; // Ø¢Ø¨ÛŒ (Ø³Ø±Ø¯)
            if (temp < 25) return '#38b000'; // Ø³Ø¨Ø² (Ù…ØªØ¹Ø§Ø¯Ù„)
            if (temp < 30) return '#ffa800'; // Ù†Ø§Ø±Ù†Ø¬ÛŒ (Ú¯Ø±Ù…)
            return '#ff6b6b'; // Ù‚Ø±Ù…Ø² (Ø®ÛŒÙ„ÛŒ Ú¯Ø±Ù…)
        }
        
        // Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ø·ÙˆØ¨Øª
        function getHumidityColor(hum) {
            if (hum < 30) return '#ffa800'; // Ù†Ø§Ø±Ù†Ø¬ÛŒ (Ø®Ø´Ú©)
            if (hum < 60) return '#38b000'; // Ø³Ø¨Ø² (Ù…ØªØ¹Ø§Ø¯Ù„)
            if (hum < 80) return '#4d96ff'; // Ø¢Ø¨ÛŒ (Ù…Ø±Ø·ÙˆØ¨)
            return '#7209b7'; // Ø¨Ù†ÙØ´ (Ø®ÛŒÙ„ÛŒ Ù…Ø±Ø·ÙˆØ¨)
        }
        
        // ÙˆØ¶Ø¹ÛŒØª Ù‡Ø± Ø±Ø¯ÛŒÙ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
        function getRowStatus(unixTime) {
            if (!unixTime) return { color: 'secondary', text: 'Ù†Ø§Ù…Ø´Ø®Øµ' };
            
            const now = Math.floor(Date.now() / 1000);
            const diff = now - unixTime;
            
            if (diff < 300) { // 5 Ø¯Ù‚ÛŒÙ‚Ù‡
                return { color: 'success', text: 'Ø¢Ù†Ù„Ø§ÛŒÙ†' };
            } else if (diff < 1800) { // 30 Ø¯Ù‚ÛŒÙ‚Ù‡
                return { color: 'warning', text: 'Ù‚Ø¯ÛŒÙ…ÛŒ' };
            } else {
                return { color: 'danger', text: 'Ø¢ÙÙ„Ø§ÛŒÙ†' };
            }
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
        function showErrorMessage(error) {
            document.getElementById('dataTable').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                            <br>
                            <small>${error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}</small>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… "Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡"
        function showNoDataMessage() {
            document.getElementById('dataTable').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Ø´Ø±ÙˆØ¹ Auto-Refresh
        function startAutoRefresh(interval = 10000) {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                loadSensorData();
            }, interval);
        }
        
        // ============ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ============
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Ø³ÛŒØ³ØªÙ… Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯');
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            loadSensorData();
            
            // Ø´Ø±ÙˆØ¹ Auto-Refresh Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡
            startAutoRefresh(10000);
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadSensorData();
            });
            
            // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' && e.ctrlKey) {
                    e.preventDefault();
                    loadSensorData();
                }
            });
        });
        
    </script>

    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</body>
</html>
