<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Real-Time Ø³Ù†Ø³ÙˆØ± ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Tahoma', 'Vazir', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .temp-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
            border: none;
        }
        .hum-card {
            background: linear-gradient(135deg, #4d96ff 0%, #6bc5ff 100%);
            color: white;
            border: none;
        }
        .sensor-value { 
            font-size: 3.5rem; 
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .live-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .data-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .table thead th {
            position: sticky;
            top: 0;
            background: #343a40;
            color: white;
            z-index: 10;
        }
        .progress-bar-temp {
            height: 8px;
            background: linear-gradient(90deg, #4d96ff, #ff6b6b);
            border-radius: 4px;
            margin-top: 10px;
        }
        .info-badge {
            font-size: 0.75rem;
            font-family: monospace;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ù‡Ø¯Ø± -->
    <div class="glass-card bg-primary text-white position-relative">
        <span class="live-badge">LIVE</span>
        <div class="card-body text-center">
            <h1 class="display-6">
                <i class="bi bi-lightning-charge-fill"></i> 
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Real-Time Ø³Ù†Ø³ÙˆØ± ESP32
            </h1>
            <p class="mb-2">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù†Ø¯Ù‡ Ø§Ø² ESP32 + AHT20</p>
            <div class="row justify-content-center">
                <div class="col-auto">
                    <span id="status" class="badge bg-warning">
                        <i class="bi bi-circle-fill"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
                    </span>
                </div>
                <div class="col-auto">
                    <span id="lastUpdate" class="badge bg-info">
                        <i class="bi bi-clock"></i> 
                        <span id="updateTime">--:--:--</span>
                    </span>
                </div>
                <div class="col-auto">
                    <span id="recordCount" class="badge bg-success">
                        <i class="bi bi-database"></i> 
                        <span id="recordNum">0</span> Ø±Ú©ÙˆØ±Ø¯
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="glass-card temp-card">
                <div class="card-body text-center py-4">
                    <h4><i class="bi bi-thermometer-sun"></i> Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ</h4>
                    <div class="sensor-value" id="tempValue">--</div>
                    <div>Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯</div>
                    <div class="progress-bar-temp">
                        <div id="tempProgress" style="width: 0%; height: 100%; background: rgba(255,255,255,0.7); border-radius: 4px;"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small>0Â°C</small>
                        <small id="tempRange">--Â°C</small>
                        <small>50Â°C</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="glass-card hum-card">
                <div class="card-body text-center py-4">
                    <h4><i class="bi bi-droplet-half"></i> Ø±Ø·ÙˆØ¨Øª ÙØ¹Ù„ÛŒ</h4>
                    <div class="sensor-value" id="humValue">--</div>
                    <div>Ø¯Ø±ØµØ¯</div>
                    <div class="progress-bar-temp mt-4">
                        <div id="humProgress" style="width: 0%; height: 100%; background: rgba(255,255,255,0.7); border-radius: 4px;"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small>0%</small>
                        <small id="humRange">--%</small>
                        <small>100%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ùˆ Ø¢Ù…Ø§Ø± -->
    <div class="glass-card">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h6><i class="bi bi-sliders"></i> Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§</h6>
                    <div class="d-grid gap-2">
                        <button id="connectBtn" class="btn btn-success btn-sm">
                            <i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„
                        </button>
                        <button id="refreshBtn" class="btn btn-primary btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-speedometer2"></i> Ø¢Ù…Ø§Ø±</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <small>Ù†Ø±Ø® Ø¢Ù¾Ø¯ÛŒØª</small>
                            <div class="info-badge bg-dark text-white p-1 rounded">5 Ø«Ø§Ù†ÛŒÙ‡</div>
                        </div>
                        <div class="col-6">
                            <small>Ø¢Ø®Ø±ÛŒÙ† ESP32</small>
                            <div id="espTime" class="info-badge bg-secondary text-white p-1 rounded">--:--</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h6>
                    <div>
                        <small>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª:</small>
                        <div id="lastFetch" class="info-badge bg-info text-white p-1 rounded">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="card-body">
                    <h5><i class="bi bi-graph-up-arrow"></i> Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨Øª</h5>
                    <div class="chart-container">
                        <canvas id="sensorChart"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Ø¢Ø®Ø±ÛŒÙ† Û²Û° Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="glass-card h-100">
                <div class="card-body">
                    <h5><i class="bi bi-list-columns-reverse"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h5>
                    <div class="data-table" id="dataTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                            </div>
                            <p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</p>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Ø¢Ø®Ø±ÛŒÙ† Û¸ Ø±Ú©ÙˆØ±Ø¯ | Ú©Ù„: <span id="totalRecords">0</span> Ø±Ú©ÙˆØ±Ø¯</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
    <div class="glass-card mt-3">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <small><i class="bi bi-cpu"></i> Ø¯Ø³ØªÚ¯Ø§Ù‡</small>
                    <div class="info-badge bg-dark text-white">ESP32</div>
                </div>
                <div class="col-md-3">
                    <small><i class="bi bi-thermometer"></i> Ø³Ù†Ø³ÙˆØ±</small>
                    <div class="info-badge bg-dark text-white">AHT20</div>
                </div>
                <div class="col-md-3">
                    <small><i class="bi bi-cloud-upload"></i> Ø¢Ù¾Ù„ÙˆØ¯</small>
                    <div class="info-badge bg-dark text-white">Ù‡Ø± Û³Û°s</div>
                </div>
                <div class="col-md-3">
                    <small><i class="bi bi-github"></i> Ù…Ø®Ø²Ù†</small>
                    <a href="https://github.com/alefadham-droid/sensor-dashboard" target="_blank" class="info-badge bg-dark text-white text-decoration-none">
                        GitHub
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class SensorDashboard {
    constructor() {
        this.dataUrl = 'https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json';
        this.dataHistory = [];
        this.chart = null;
        this.updateInterval = null;
        this.totalRecords = 0;
        this.isConnected = true;
        this.lastFetchTime = null;
        
        this.init();
    }

    init() {
        console.log('ğŸš€ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù†Ø³ÙˆØ± ESP32 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
        console.log('ğŸ“ Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡:', this.dataUrl);
        
        this.initChart();
        this.setupEventListeners();
        this.updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...', 'warning');
        
        // Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡
        this.fetchData();
        this.startAutoUpdate();
        
        // Ù„Ø§Ú¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        setInterval(() => {
            console.log('ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:', {
                Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ_Ø°Ø®ÛŒØ±Ù‡_Ø´Ø¯Ù‡: this.dataHistory.length,
                Ø¢Ø®Ø±ÛŒÙ†_Ø¯Ø±ÛŒØ§ÙØª: this.lastFetchTime ? this.timeSince(this.lastFetchTime) + ' Ù¾ÛŒØ´' : 'Ù‡Ø±Ú¯Ø²',
                ÙˆØ¶Ø¹ÛŒØª_Ø§ØªØµØ§Ù„: this.isConnected ? 'Ù…ØªØµÙ„' : 'Ù‚Ø·Ø¹'
            });
        }, 30000);
    }

    setupEventListeners() {
        // Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„/Ù‚Ø·Ø¹
        document.getElementById('connectBtn').addEventListener('click', () => {
            if (this.isConnected) {
                this.stopAutoUpdate();
                document.getElementById('connectBtn').innerHTML = '<i class="bi bi-plug"></i> Ø§ØªØµØ§Ù„';
                document.getElementById('connectBtn').className = 'btn btn-success btn-sm';
                this.updateStatus('Ù‚Ø·Ø¹ Ø´Ø¯Ù‡', 'secondary');
            } else {
                this.startAutoUpdate();
                document.getElementById('connectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Ù‚Ø·Ø¹';
                document.getElementById('connectBtn').className = 'btn btn-danger btn-sm';
                this.updateStatus('Ù…ØªØµÙ„', 'success');
            }
        });

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.fetchData();
            this.updateStatus('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ...', 'info');
        });

        // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                this.fetchData();
                this.showToast('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'info');
            }
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                document.getElementById('connectBtn').click();
            }
        });
    }

    async fetchData() {
        try {
            console.log('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡...');
            
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ù…Ø±ÙˆØ±Ú¯Ø±
            const timestamp = Date.now();
            const url = `${this.dataUrl}?t=${timestamp}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            this.lastFetchTime = new Date();
            
            console.log('âœ… Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', {
                Ù†ÙˆØ¹: Array.isArray(data) ? 'Ø¢Ø±Ø§ÛŒÙ‡' : 'Ø¢Ø¨Ø¬Ú©Øª',
                Ø§Ù†Ø¯Ø§Ø²Ù‡: Array.isArray(data) ? data.length : 1
            });
            
            this.processData(data);
            this.updateStatus('Ù…ØªØµÙ„', 'success');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
            this.updateStatus('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„', 'danger');
            
            // Ø¨Ø¹Ø¯ Ø§Ø² Û³ Ø¨Ø§Ø± Ø®Ø·Ø§ØŒ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            if (!this.lastFetchTime || (new Date() - this.lastFetchTime) > 60000) {
                this.showSampleData();
            }
        }
    }

    processData(rawData) {
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
        
        if (dataArray.length === 0) {
            console.warn('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            return;
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø¨Ø¯ÙˆÙ† ØªÚ©Ø±Ø§Ø±)
        dataArray.forEach(newItem => {
            const exists = this.dataHistory.some(item => item.id === newItem.id);
            if (!exists) {
                this.dataHistory.push(newItem);
                this.totalRecords++;
            }
        });
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.dataHistory.length > 50) {
            this.dataHistory = this.dataHistory.slice(-50);
        }
        
        // Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯
        const latest = dataArray[dataArray.length - 1];
        console.log('ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯:', latest);
        
        // Ø¢Ù¾Ø¯ÛŒØª UI
        this.updateUI(latest);
        this.updateTable();
        this.updateChart();
        this.updateStats();
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        if (dataArray.length > 0) {
            this.showToast(`${dataArray.length} Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`, 'success');
        }
    }

    updateUI(latest) {
        // Ø¯Ù…Ø§
        if (latest.temperature !== undefined) {
            const temp = latest.temperature;
            document.getElementById('tempValue').textContent = temp.toFixed(1);
            document.getElementById('tempRange').textContent = temp.toFixed(1) + 'Â°C';
            
            // Ù¾ÛŒØ´Ø±ÙØªâ€ŒØ¨Ø§Ø± Ø¯Ù…Ø§ (Û° ØªØ§ ÛµÛ° Ø¯Ø±Ø¬Ù‡)
            const tempPercent = Math.min((temp / 50) * 100, 100);
            document.getElementById('tempProgress').style.width = tempPercent + '%';
        }
        
        // Ø±Ø·ÙˆØ¨Øª
        if (latest.humidity !== undefined) {
            const hum = latest.humidity;
            document.getElementById('humValue').textContent = hum.toFixed(1);
            document.getElementById('humRange').textContent = hum.toFixed(1) + '%';
            
            // Ù¾ÛŒØ´Ø±ÙØªâ€ŒØ¨Ø§Ø± Ø±Ø·ÙˆØ¨Øª
            document.getElementById('humProgress').style.width = hum + '%';
        }
        
        // Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§
        const now = new Date();
        document.getElementById('updateTime').textContent = now.toLocaleTimeString('fa-IR');
        document.getElementById('lastFetch').textContent = 'Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†';
        
        if (latest.timestamp) {
            document.getElementById('espTime').textContent = latest.timestamp.split(':').slice(0, 2).join(':');
        }
    }

    updateTable() {
        const tableContainer = document.getElementById('dataTable');
        const recentData = this.dataHistory.slice(-8).reverse();
        
        if (recentData.length === 0) {
            tableContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                    </div>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø²Ù…Ø§Ù†</th>
                            <th>Ø¯Ù…Ø§</th>
                            <th>Ø±Ø·ÙˆØ¨Øª</th>
                            <th>Ø´Ù†Ø§Ø³Ù‡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        recentData.forEach((item, index) => {
            // Ø±Ù†Ú¯â€ŒØ¨Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø¯Ø§Ø±
            const tempClass = item.temperature > 28 ? 'table-warning' : '';
            const humClass = item.humidity > 70 ? 'table-info' : '';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.timestamp || '--:--:--'}</td>
                    <td class="${tempClass}">
                        ${item.temperature !== undefined ? item.temperature.toFixed(1) + 'Â°C' : '--'}
                    </td>
                    <td class="${humClass}">
                        ${item.humidity !== undefined ? item.humidity.toFixed(1) + '%' : '--'}
                    </td>
                    <td><span class="badge bg-secondary">${item.id || '--'}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
    }

    initChart() {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ø¯Ù…Ø§ (Â°C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Ø±Ø·ÙˆØ¨Øª (%)',
                        data: [],
                        borderColor: '#4d96ff',
                        backgroundColor: 'rgba(77, 150, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            font: { family: 'Tahoma, sans-serif', size: 11 },
                            maxRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Ø¯Ù…Ø§ (Â°C)',
                            font: { family: 'Tahoma, sans-serif', size: 12 }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        suggestedMin: 0,
                        suggestedMax: 50
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Ø±Ø·ÙˆØ¨Øª (%)',
                            font: { family: 'Tahoma, sans-serif', size: 12 }
                        },
                        grid: { drawOnChartArea: false },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            font: { family: 'Tahoma, sans-serif', size: 13 }
                        }
                    },
                    tooltip: {
                        rtl: true,
                        titleFont: { family: 'Tahoma, sans-serif' },
                        bodyFont: { family: 'Tahoma, sans-serif' },
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`
                        }
                    }
                }
            }
        });
    }

    updateChart() {
        if (!this.chart || this.dataHistory.length === 0) return;
        
        // Ø¢Ø®Ø±ÛŒÙ† Û²Û° Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
        const chartData = this.dataHistory.slice(-20);
        
        // Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø³Ø§Ø¹Øª:Ø¯Ù‚ÛŒÙ‚Ù‡)
        const labels = chartData.map(d => {
            if (d.timestamp) {
                const parts = d.timestamp.split(':');
                return parts[0] + ':' + parts[1];
            }
            return '--:--';
        });
        
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const temps = chartData.map(d => d.temperature || 0);
        const hums = chartData.map(d => d.humidity || 0);
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±
        this.chart.data.labels = labels;
        this.chart.data.datasets[0].data = temps;
        this.chart.data.datasets[1].data = hums;
        
        // ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚ÛŒØ§Ø³ Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ©
        if (temps.length > 0) {
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            this.chart.options.scales.y.suggestedMin = Math.floor(minTemp) - 2;
            this.chart.options.scales.y.suggestedMax = Math.ceil(maxTemp) + 2;
        }
        
        if (hums.length > 0) {
            const minHum = Math.min(...hums);
            const maxHum = Math.max(...hums);
            this.chart.options.scales.y1.suggestedMin = Math.floor(minHum) - 5;
            this.chart.options.scales.y1.suggestedMax = Math.ceil(maxHum) + 5;
        }
        
        this.chart.update('none');
    }

    updateStats() {
        document.getElementById('recordNum').textContent = this.dataHistory.length;
        document.getElementById('totalRecords').textContent = this.totalRecords;
        document.getElementById('recordCount').textContent = `${this.dataHistory.length} Ø±Ú©ÙˆØ±Ø¯`;
    }

    updateStatus(text, type) {
        const element = document.getElementById('status');
        element.innerHTML = `<i class="bi bi-circle-fill"></i> ${text}`;
        element.className = `badge bg-${type}`;
    }

    startAutoUpdate() {
        this.isConnected = true;
        this.updateInterval = setInterval(() => {
            this.fetchData();
        }, 5000); // Ù‡Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡
        
        console.log('ğŸ”„ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯ (Ù‡Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡)');
    }

    stopAutoUpdate() {
        this.isConnected = false;
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        console.log('â¹ï¸ Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯');
    }

    showSampleData() {
        const sampleData = [{
            id: this.totalRecords + 1,
            timestamp: new Date().toLocaleTimeString('fa-IR').slice(0, 8),
            temperature: 24.5 + Math.random() * 2,
            humidity: 55 + Math.random() * 5,
            sensor: "AHT20",
            device: "ESP32"
        }];
        
        this.processData(sampleData);
        
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù†
        const tableContainer = document.getElementById('dataTable');
        tableContainer.innerHTML = `
            <div class="alert alert-warning mb-2">
                <i class="bi bi-exclamation-triangle"></i>
                Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡
            </div>
            ${tableContainer.innerHTML}
        `;
    }

    showToast(message, type = 'info') {
        // Ø§ÛŒØ¬Ø§Ø¯ toast Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0 position-fixed" style="bottom: 20px; left: 20px; z-index: 1050;">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
        
        // Ø­Ø°Ù Ù¾Ø³ Ø§Ø² Ù†Ù…Ø§ÛŒØ´
        toastEl.addEventListener('hidden.bs.toast', () => {
            toastEl.remove();
        });
    }

    timeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return `${seconds} Ø«Ø§Ù†ÛŒÙ‡`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} Ø³Ø§Ø¹Øª`;
        return Math.floor(hours / 24) + ' Ø±ÙˆØ²';
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…
document.addEventListener('DOMContentLoaded', () => {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ bootstrap toast
    const toastScript = document.createElement('script');
    toastScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
    document.head.appendChild(toastScript);
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    window.dashboard = new SensorDashboard();
    
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù†Ø³ÙˆÙ„
    console.log('ğŸ‰ Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
    console.log('ğŸ® Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§:');
    console.log('   â€¢ Space = Ù‚Ø·Ø¹/ÙˆØµÙ„ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©');
    console.log('   â€¢ R = Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÛŒ');
    console.log('   â€¢ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„');
});
</script>

<!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</body>
</html>
