// ============================================
// ESP32 Sensor Dashboard - Complete Version
// GitHub: https://github.com/alefadham-droid/sensor-dashboard
// ============================================

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Wire.h>
#include <Adafruit_AHTX0.h>

Adafruit_AHTX0 aht;

// ============ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ============
const char* ssid = "Amc";
const char* password = "12345678";
const char* githubToken = "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"; // ØªÙˆÚ©Ù†Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±

const char* username = "alefadham-droid";
const char* repoName = "sensor-dashboard";
const char* dataFile = "data/sensor-data.json";

// ============ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… ============
String fileSHA = "";
unsigned long lastUploadTime = 0;
const unsigned long UPLOAD_INTERVAL = 60000; // Ù‡Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡
int dataCount = 0;

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("\n" + String(60, '='));
  Serial.println("ğŸŒ¡ï¸  ESP32 Sensor Dashboard v2.0");
  Serial.println("ğŸ“Š GitHub: github.com/alefadham-droid/sensor-dashboard");
  Serial.println(String(60, '=') + "\n");
  
  // 1. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ù†Ø³ÙˆØ±
  setupSensor();
  
  // 2. Ø§ØªØµØ§Ù„ WiFi
  setupWiFi();
  
  // 3. ØªØ³Øª GitHub
  testGitHub();
  
  // 4. Ø´Ø±ÙˆØ¹ Ú©Ø§Ø±
  Serial.println("\nâœ… Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!");
  Serial.println("ğŸ“¡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯");
  Serial.println("ğŸŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡: https://alefadham-droid.github.io/sensor-dashboard/");
  Serial.println(String(60, '-') + "\n");
}

void loop() {
  // Ø®ÙˆØ§Ù†Ø¯Ù† Ø³Ù†Ø³ÙˆØ±
  readSensor();
  
  // Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ GitHub
  if (millis() - lastUploadTime >= UPLOAD_INTERVAL) {
    uploadToGitHub();
    lastUploadTime = millis();
  }
  
  delay(5000); // Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡ Ø³Ù†Ø³ÙˆØ± Ø±Ùˆ Ø¨Ø®ÙˆÙ†
}

// ============ Ø³Ù†Ø³ÙˆØ± ============
void setupSensor() {
  Serial.print("ğŸ”§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ù†Ø³ÙˆØ± AHT20... ");
  
  Wire.begin(21, 22); // SDA=GPIO21, SCL=GPIO22
  
  if (!aht.begin()) {
    Serial.println("âŒ Ø®Ø·Ø§! Ø³Ù†Ø³ÙˆØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
    Serial.println("   Ø§ØªØµØ§Ù„Ø§Øª Ø±Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†:");
    Serial.println("   SDA -> GPIO21");
    Serial.println("   SCL -> GPIO22");
    Serial.println("   VCC -> 3.3V");
    Serial.println("   GND -> GND");
    while(1) delay(1000);
  }
  
  Serial.println("âœ… OK");
}

float currentTemp = 0;
float currentHum = 0;

void readSensor() {
  sensors_event_t humidity, temp;
  
  if (aht.getEvent(&humidity, &temp)) {
    currentTemp = temp.temperature;
    currentHum = humidity.relative_humidity;
    
    Serial.print("ğŸ“¡ Ø³Ù†Ø³ÙˆØ±: ");
    Serial.print(currentTemp, 1);
    Serial.print("Â°C | ");
    Serial.print(currentHum, 1);
    Serial.println("%");
    
  } else {
    Serial.println("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø³Ù†Ø³ÙˆØ±");
  }
}

// ============ WiFi ============
void setupWiFi() {
  Serial.print("ğŸ“¶ Ø§ØªØµØ§Ù„ Ø¨Ù‡ WiFi... ");
  
  WiFi.begin(ssid, password);
  int attempts = 0;
  
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi Ù…ØªØµÙ„");
    Serial.print("   IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ WiFi");
    ESP.restart();
  }
}

// ============ GitHub ============
void testGitHub() {
  Serial.print("ğŸ”— ØªØ³Øª Ø§ØªØµØ§Ù„ GitHub... ");
  
  HTTPClient http;
  String url = String("https://api.github.com/repos/") + username + "/" + repoName;
  
  http.begin(url);
  http.addHeader("Authorization", "Bearer " + String(githubToken));
  http.addHeader("User-Agent", "ESP32-Sensor");
  
  int code = http.GET();
  
  if (code == 200) {
    Serial.println("âœ… OK");
  } else {
    Serial.print("âŒ Ø®Ø·Ø§: ");
    Serial.println(code);
  }
  
  http.end();
}

void uploadToGitHub() {
  dataCount++;
  Serial.print("\nğŸ”„ Ø¢Ù¾Ù„ÙˆØ¯ #");
  Serial.print(dataCount);
  Serial.print(" (");
  Serial.print(millis() / 1000);
  Serial.println("s)");
  
  // 1. Ú¯Ø±ÙØªÙ† SHA ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ
  if (fileSHA == "") {
    getFileSHA();
  }
  
  // 2. Ø³Ø§Ø®Øª Ø¯Ø§Ø¯Ù‡ JSON
  String jsonData = createJSONData();
  
  // 3. Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ GitHub
  bool success = uploadFile(jsonData);
  
  if (success) {
    Serial.println("âœ… Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
    printSuccessInfo();
  } else {
    Serial.println("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡");
    fileSHA = ""; // Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
  }
}

void getFileSHA() {
  Serial.print("ğŸ“‹ Ø¯Ø±ÛŒØ§ÙØª SHA ÙØ§ÛŒÙ„... ");
  
  HTTPClient http;
  String url = String("https://api.github.com/repos/") + username + "/" + repoName + "/contents/" + dataFile;
  
  http.begin(url);
  http.addHeader("Authorization", "Bearer " + String(githubToken));
  http.addHeader("User-Agent", "ESP32");
  
  int code = http.GET();
  
  if (code == 200) {
    String response = http.getString();
    DynamicJsonDocument doc(1024);
    deserializeJson(doc, response);
    
    fileSHA = doc["sha"].as<String>();
    Serial.println("Ù…ÙˆÙÙ‚");
    
  } else if (code == 404) {
    Serial.println("ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ (Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±)");
    fileSHA = "";
  } else {
    Serial.print("Ø®Ø·Ø§: ");
    Serial.println(code);
    fileSHA = "";
  }
  
  http.end();
}

String createJSONData() {
  unsigned long uptime = millis() / 1000;
  unsigned long hours = uptime / 3600;
  unsigned long minutes = (uptime % 3600) / 60;
  unsigned long seconds = uptime % 60;
  
  char timeStr[12];
  snprintf(timeStr, sizeof(timeStr), "%02lu:%02lu:%02lu", hours, minutes, seconds);
  
  // Ø³Ø§Ø®Øª JSON
  String json = "[";
  json += "{";
  json += "\"id\":" + String(dataCount) + ",";
  json += "\"timestamp\":\"" + String(timeStr) + "\",";
  json += "\"unix_time\":" + String(uptime) + ",";
  json += "\"temperature\":" + String(currentTemp, 1) + ",";
  json += "\"humidity\":" + String(currentHum, 1) + ",";
  json += "\"sensor\":\"AHT20\",";
  json += "\"device\":\"ESP32\"";
  json += "}";
  json += "]";
  
  return json;
}

bool uploadFile(String jsonData) {
  Serial.print("ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ GitHub... ");
  
  HTTPClient http;
  String url = String("https://api.github.com/repos/") + username + "/" + repoName + "/contents/" + dataFile;
  
  // Base64 encode
  String encoded = base64Encode(jsonData);
  
  // Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…
  String message = "Ø³Ù†Ø³ÙˆØ± #" + String(dataCount) + 
                  " | Ø¯Ù…Ø§: " + String(currentTemp, 1) + 
                  "Â°C, Ø±Ø·ÙˆØ¨Øª: " + String(currentHum, 1) + "%";
  
  // Ø³Ø§Ø®Øª payload
  String payload = "{";
  payload += "\"message\":\"" + message + "\",";
  payload += "\"content\":\"" + encoded + "\"";
  
  if (fileSHA != "") {
    payload += ",\"sha\":\"" + fileSHA + "\"";
  }
  
  payload += "}";
  
  http.begin(url);
  http.addHeader("Authorization", "Bearer " + String(githubToken));
  http.addHeader("Content-Type", "application/json");
  http.addHeader("User-Agent", "ESP32-Sensor");
  
  int code = http.PUT(payload);
  
  if (code == 200 || code == 201) {
    Serial.println("Ù…ÙˆÙÙ‚");
    
    // Ú¯Ø±ÙØªÙ† SHA Ø¬Ø¯ÛŒØ¯
    String response = http.getString();
    DynamicJsonDocument doc(1024);
    if (!deserializeJson(doc, response)) {
      fileSHA = doc["content"]["sha"].as<String>();
    }
    
    http.end();
    return true;
  } else {
    Serial.print("Ø®Ø·Ø§ (Ú©Ø¯: ");
    Serial.print(code);
    Serial.println(")");
    
    String response = http.getString();
    Serial.println("Ù¾Ø§Ø³Ø®: " + response);
    
    http.end();
    return false;
  }
}

// ============ Base64 Encode ============
String base64Encode(String input) {
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² encode Ø³Ø§Ø¯Ù‡ Ùˆ Ù…Ø·Ù…Ø¦Ù†
  String base64Chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
  String result = "";
  int i = 0;
  int len = input.length();
  
  while (i < len) {
    int byte1 = i < len ? input[i++] : 0;
    int byte2 = i < len ? input[i++] : 0;
    int byte3 = i < len ? input[i++] : 0;
    
    int triple = (byte1 << 16) | (byte2 << 8) | byte3;
    
    result += base64Chars[(triple >> 18) & 0x3F];
    result += base64Chars[(triple >> 12) & 0x3F];
    result += base64Chars[(triple >> 6) & 0x3F];
    result += base64Chars[triple & 0x3F];
  }
  
  // Padding
  if (len % 3 == 1) {
    result[result.length() - 1] = '=';
    result[result.length() - 2] = '=';
  } else if (len % 3 == 2) {
    result[result.length() - 1] = '=';
  }
  
  return result;
}

// ============ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ============
void printSuccessInfo() {
  Serial.println("ğŸ”— Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯:");
  Serial.println("   ğŸ“Š Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: https://raw.githubusercontent.com/alefadham-droid/sensor-dashboard/main/data/sensor-data.json");
  Serial.println("   ğŸŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯: https://alefadham-droid.github.io/sensor-dashboard/");
  Serial.println("   ğŸ“ Ù…Ø®Ø²Ù†: https://github.com/alefadham-droid/sensor-dashboard");
  Serial.println(String(40, '-'));
}

// ============ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª ============
void printStatus() {
  Serial.println("\nğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:");
  Serial.println("  " + String(25, '-'));
  Serial.print("  ğŸŒ¡ï¸  Ø¯Ù…Ø§: ");
  Serial.print(currentTemp, 1);
  Serial.println("Â°C");
  Serial.print("  ğŸ’§ Ø±Ø·ÙˆØ¨Øª: ");
  Serial.print(currentHum, 1);
  Serial.println("%");
  Serial.print("  ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¯Ù‡: ");
  Serial.println(dataCount);
  Serial.print("  ğŸ“¶ Ù‚Ø¯Ø±Øª Ø³ÛŒÚ¯Ù†Ø§Ù„: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");
  Serial.println("  " + String(25, '-'));
}
